# 本地部署让别人访问指南

在购买服务器之前，你可以先在本地电脑上部署，让别人通过公网访问。以下是几种方案：

---

## 方案对比

| 方案 | 优点 | 缺点 | 费用 | 推荐度 |
|------|------|------|------|--------|
| **内网穿透（ngrok）** | 简单快速，5分钟搞定 | 免费版域名随机变化 | 免费/付费 | ⭐⭐⭐⭐⭐ |
| **内网穿透（frp）** | 免费，可自定义域名 | 需要自己搭建服务器 | 免费 | ⭐⭐⭐⭐ |
| **内网穿透（花生壳）** | 国内服务，稳定 | 免费版有限制 | 免费/付费 | ⭐⭐⭐⭐ |
| **路由器端口转发** | 完全免费 | 需要公网IP，配置复杂 | 免费 | ⭐⭐⭐ |
| **Cloudflare Tunnel** | 免费，稳定 | 需要注册账号 | 免费 | ⭐⭐⭐⭐ |

---

## 方案1：使用 ngrok（最简单，推荐）⭐

### 优点
- ✅ 5分钟即可完成
- ✅ 自动生成 HTTPS 域名
- ✅ 免费版可用（有使用限制）
- ✅ 无需配置路由器

### 步骤

#### 1. 注册 ngrok 账号

访问：https://ngrok.com/
- 点击 "Sign up" 注册账号（免费）
- 验证邮箱

#### 2. 获取 Authtoken

登录后，在 Dashboard 找到你的 Authtoken，类似：
```
2abc123def456ghi789jkl012mno345pq_6rst789uvw012xyz345abc678def
```

#### 3. 安装 ngrok

**macOS**：
```bash
# 使用 Homebrew
brew install ngrok/ngrok/ngrok

# 或下载二进制文件
# 访问 https://ngrok.com/download 下载
```

**Windows**：
- 访问 https://ngrok.com/download
- 下载 Windows 版本
- 解压到任意目录

**Linux**：
```bash
# 下载
wget https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-linux-amd64.tgz
tar -xzf ngrok-v3-stable-linux-amd64.tgz
sudo mv ngrok /usr/local/bin/
```

#### 4. 配置 ngrok

```bash
# 设置 Authtoken
ngrok config add-authtoken 你的Authtoken

# 验证配置
ngrok config check
```

#### 5. 启动你的应用

```bash
cd /Users/liuzirui/Desktop/openEar/openEar
./run_prod.sh
```

#### 6. 启动 ngrok 隧道

**新开一个终端窗口**，运行：

```bash
# 将 5001 替换为你的应用端口
ngrok http 5001
```

你会看到类似输出：
```
Session Status                online
Account                       你的账号
Version                       3.x.x
Region                        United States (us)
Latency                       45ms
Web Interface                 http://127.0.0.1:4040
Forwarding                    https://abc123.ngrok-free.app -> http://localhost:5001
```

**重要**：`https://abc123.ngrok-free.app` 就是你的公网访问地址！

#### 7. 分享链接

将 `https://abc123.ngrok-free.app` 分享给别人即可访问。

### ngrok 免费版限制

- ✅ 每次启动域名会变化（可以付费固定域名）
- ✅ 有连接数限制
- ✅ 适合测试和小规模使用

### 固定域名（付费功能）

如果需要固定域名，可以：
1. 升级到付费版（$8/月起）
2. 或使用方案2（frp）自己搭建

---

## 方案2：使用 frp（免费，可自定义域名）⭐

### 优点
- ✅ 完全免费
- ✅ 可以自定义域名（如果有域名）
- ✅ 无连接数限制

### 缺点
- ❌ 需要一台有公网IP的服务器（或使用免费frp服务器）

### 使用免费 frp 服务器

#### 1. 下载 frp 客户端

访问：https://github.com/fatedier/frp/releases

下载对应系统的版本：
- macOS: `frp_*_darwin_amd64.tar.gz`
- Windows: `frp_*_windows_amd64.zip`
- Linux: `frp_*_linux_amd64.tar.gz`

#### 2. 使用免费 frp 服务

**免费 frp 服务器列表**（需要自己搜索，这里提供示例配置）：

创建 `frpc.ini` 文件：

```ini
[common]
# 使用免费 frp 服务器（需要找到可用的）
server_addr = free.frp.example.com
server_port = 7000

[openear]
type = http
local_port = 5001
custom_domains = 你的自定义域名.free.frp.example.com
```

#### 3. 启动 frp 客户端

```bash
./frpc -c frpc.ini
```

---

## 方案3：使用花生壳（国内服务）⭐

### 优点
- ✅ 国内服务，速度快
- ✅ 有免费版
- ✅ 支持固定域名（付费）

### 步骤

#### 1. 注册账号

访问：https://hsk.oray.com/
- 注册账号
- 完成实名认证（免费版需要）

#### 2. 下载客户端

- macOS: 下载 macOS 版本
- Windows: 下载 Windows 版本

#### 3. 配置映射

1. 登录花生壳客户端
2. 点击"内网穿透"
3. 添加映射：
   - **应用名称**：openEar
   - **内网主机**：127.0.0.1
   - **内网端口**：5001
   - **外网域名**：系统自动分配（免费版）或自定义（付费版）

#### 4. 启动映射

点击"启动"，获得公网访问地址，如：`http://abc123.gicp.net:12345`

### 花生壳免费版限制

- 每月 1GB 流量
- 带宽限制
- 适合测试使用

---

## 方案4：使用 Cloudflare Tunnel（免费，稳定）⭐

### 优点
- ✅ 完全免费
- ✅ 稳定可靠
- ✅ 自动 HTTPS
- ✅ 可以绑定自己的域名

### 步骤

#### 1. 安装 cloudflared

**macOS**：
```bash
brew install cloudflared
```

**其他系统**：
访问：https://developers.cloudflare.com/cloudflare-one/connections/connect-apps/install-and-setup/installation/

#### 2. 登录 Cloudflare

```bash
cloudflared tunnel login
```

会打开浏览器，登录 Cloudflare 账号（免费注册）。

#### 3. 创建隧道

```bash
cloudflared tunnel create openear
```

#### 4. 配置路由（如果有域名）

如果有自己的域名并在 Cloudflare 管理：

```bash
# 配置 DNS
cloudflared tunnel route dns openear 你的域名.com

# 运行隧道
cloudflared tunnel run openear
```

#### 5. 快速启动（无域名）

如果没有域名，可以直接运行：

```bash
cloudflared tunnel --url http://localhost:5001
```

会得到一个临时域名，如：`https://abc-123.trycloudflare.com`

---

## 方案5：路由器端口转发（需要公网IP）

### 适用场景
- 你的网络有公网IP
- 可以访问路由器管理界面
- 愿意配置路由器

### 步骤

#### 1. 检查是否有公网IP

访问：https://www.ipip.net/ip.html
查看显示的IP，然后访问路由器管理界面，对比WAN口IP是否一致。

#### 2. 配置路由器端口转发

1. 登录路由器管理界面（通常是 192.168.1.1 或 192.168.0.1）
2. 找到"端口转发"或"虚拟服务器"功能
3. 添加规则：
   - **外部端口**：5001（或80/443）
   - **内部IP**：你的电脑内网IP（如 192.168.1.100）
   - **内部端口**：5001
   - **协议**：TCP

#### 3. 查看公网IP

访问：https://www.ipip.net/ip.html
获取你的公网IP地址。

#### 4. 访问

通过 `http://你的公网IP:5001` 访问。

### 注意事项

- ⚠️ 需要配置防火墙允许端口
- ⚠️ 公网IP可能会变化（可以使用DDNS）
- ⚠️ 安全性较低，建议只用于测试

---

## 推荐方案选择

### 快速测试（推荐 ngrok）
```bash
# 1. 安装 ngrok
brew install ngrok/ngrok/ngrok

# 2. 配置 token
ngrok config add-authtoken 你的token

# 3. 启动应用
cd /Users/liuzirui/Desktop/openEar/openEar
./run_prod.sh

# 4. 新终端启动 ngrok
ngrok http 5001
```

### 长期使用（推荐 Cloudflare Tunnel）
- 免费
- 稳定
- 可以绑定自己的域名

---

## 本地部署完整步骤

### 1. 确保应用正常运行

```bash
cd /Users/liuzirui/Desktop/openEar/openEar

# 启动生产环境
./run_prod.sh
```

在浏览器访问 `http://localhost:5001` 确认可以正常访问。

### 2. 配置防火墙（macOS）

```bash
# 允许端口 5001
sudo /usr/libexec/ApplicationFirewall/socketfilterfw --add /usr/local/bin/python
sudo /usr/libexec/ApplicationFirewall/socketfilterfw --unblockapp /usr/local/bin/python
```

### 3. 选择内网穿透方案

推荐使用 **ngrok**（最简单）或 **Cloudflare Tunnel**（免费稳定）。

### 4. 分享链接

将获得公网地址分享给其他人即可。

---

## 常见问题

### Q: 免费版 ngrok 域名每次都不一样？
A: 是的，这是免费版的限制。可以：
- 升级到付费版（$8/月）获得固定域名
- 使用 Cloudflare Tunnel 绑定自己的域名（免费）

### Q: 访问速度慢？
A: 内网穿透会有一定延迟，这是正常的。正式使用建议购买服务器。

### Q: 可以用于生产环境吗？
A: 免费版适合测试和小规模使用。正式生产环境建议购买服务器。

### Q: 如何查看访问日志？
A: 
- ngrok: 访问 http://127.0.0.1:4040 查看
- 应用日志: 查看 `logs/access.log` 和 `logs/error.log`

### Q: 如何停止内网穿透？
A: 在运行内网穿透的终端按 `Ctrl+C` 即可。

---

## 下一步

1. ✅ 先在本地测试内网穿透
2. ✅ 让朋友测试访问
3. ✅ 评估使用情况
4. ✅ 如果效果好，再考虑购买服务器和域名

这样可以先验证应用是否满足需求，再决定是否投入服务器成本！

