{% extends "base.html" %}

{% block title %}{{ exercise_info.name }} - openEar{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/practice.css') }}">
{% endblock %}

{% block content %}
<div class="practice-layout">
    <!-- å·¦ä¾§è¾¹æ  -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <button class="sidebar-toggle" id="sidebar-toggle" title="æ”¶èµ·/å±•å¼€ä¾§è¾¹æ ">
                <span class="toggle-icon">â—€</span>
            </button>
            <div class="sidebar-tabs">
                <button class="sidebar-tab active" data-tab="settings">è®¾ç½®</button>
                <button class="sidebar-tab" data-tab="explanation">è¯´æ˜</button>
                <button class="sidebar-tab" data-tab="listen">æ­Œå•</button>
            </div>
        </div>

        <div class="sidebar-content">
            <!-- Settings æ ‡ç­¾é¡µ -->
            <div class="tab-content active" id="settings-tab">
                <div class="sidebar-section">
                    <h3>ç»ƒä¹ è®¾ç½®</h3>
                    <form id="settings-form" class="settings-form">
                        {% if exercise_type == 'interval' %}
                        <div class="form-group">
                            <label>é€‰æ‹©éŸ³ç¨‹ï¼š</label>
                            <div class="checkbox-group">
                                {% for semitone, interval in intervals.items() %}
                                <label class="checkbox-item">
                                    <input type="checkbox" name="intervals" value="{{ interval.name }}" checked>
                                    <span>{{ interval.cn }}</span>
                                </label>
                                {% endfor %}
                            </div>
                            <div style="margin-top: 12px;">
                                <label class="checkbox-item">
                                    <input type="checkbox" id="select-all-intervals">
                                    <strong>å…¨é€‰</strong>
                                </label>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>â†•ï¸ æ–¹å‘ï¼š</label>
                            <div class="checkbox-group">
                                <label class="checkbox-item">
                                    <input type="checkbox" name="directions" value="up" checked>
                                    <span>ä¸Šè¡Œ</span>
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="directions" value="down" checked>
                                    <span>ä¸‹è¡Œ</span>
                                </label>
                            </div>
                        </div>
                        {% elif exercise_type == 'scale_degree' %}
                        <div class="form-group">
                            <label>ğŸ¼ é€‰æ‹©éŸ³é˜¶ï¼š</label>
                            <select name="scale_type" class="form-select">
                                {% for scale_key, scale_info in scales.items() %}
                                <option value="{{ scale_key }}" {% if scale_key == 'major' %}selected{% endif %}>
                                    {{ scale_info.name }} ({{ scale_info.name_en }})
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group">
                            <label>ğŸ¹ é€‰æ‹©è°ƒæ€§ï¼š</label>
                            <select name="key" class="form-select">
                                {% for key in keys %}
                                <option value="{{ key }}" {% if key == 'C' %}selected{% endif %}>{{ key }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group">
                            <label>ğŸšï¸ èµ·å§‹å…«åº¦ï¼š</label>
                            <select name="octave" class="form-select">
                                <option value="3">3</option>
                                <option value="4" selected>4</option>
                                <option value="5">5</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>ğŸ¹ å…«åº¦èŒƒå›´ï¼š</label>
                            <select name="octave_range" class="form-select">
                                <option value="1" selected>ä¸€ä¸ªå…«åº¦</option>
                                <option value="2">ä¸¤ä¸ªå…«åº¦</option>
                            </select>
                            <p style="font-size: 11px; color: var(--hf-text-tertiary); margin-top: 4px;">
                                ä¸¤ä¸ªå…«åº¦æ—¶ï¼Œé¢˜ç›®å¯èƒ½åŒ…å«ç¬¬äºŒä¸ªå…«åº¦çš„éŸ³ï¼ˆå¦‚9éŸ³ã€10éŸ³ç­‰ï¼‰
                            </p>
                        </div>
                        {% endif %}
                        <div class="form-group">
                            <label>ğŸ”¢ é¢˜ç›®æ•°é‡ï¼š</label>
                            <select name="total_questions" class="form-select">
                                <option value="10">10é¢˜</option>
                                <option value="20" selected>20é¢˜</option>
                                <option value="30">30é¢˜</option>
                                <option value="50">50é¢˜</option>
                            </select>
                        </div>
                        <button type="button" class="btn" onclick="applySettings()">
                            <span>ğŸ’¾</span> åº”ç”¨è®¾ç½®
                        </button>
                    </form>
                </div>
            </div>

            <!-- Explanation æ ‡ç­¾é¡µ -->
            <div class="tab-content" id="explanation-tab">
                <div class="sidebar-section">
                    <h3>ğŸ“– ç»ƒä¹ è¯´æ˜</h3>
                    {% if tips.explanation %}
                    <div class="explanation-content">
                        {{ tips.explanation | safe }}
                    </div>
                    {% else %}
                    <p>ç»ƒä¹ è¯´æ˜åŠ è½½ä¸­...</p>
                    {% endif %}
                </div>
                {% if tips.tips %}
                <div class="sidebar-section">
                    <h3>ğŸ’¡ ç»ƒä¹ æŠ€å·§</h3>
                    <ul class="tips-list">
                        {% for tip in tips.tips %}
                        <li>{{ tip }}</li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}
            </div>

            <!-- Listen æ ‡ç­¾é¡µ -->
            <div class="tab-content" id="listen-tab">
                <div class="sidebar-section">
                    <h3>ğŸµ å‚è€ƒæ­Œæ›²</h3>
                    <p style="font-size: 12px; color: var(--hf-text-tertiary); margin-bottom: 12px;">
                        ğŸ’¡ <strong>Pro Tip:</strong> ä»¥ä¸‹æ­Œæ›²å¯ä»¥å¸®åŠ©æ‚¨æ›´å¥½åœ°è¯†åˆ«éŸ³ç¨‹ã€‚å»ºè®®åœ¨ <span class="geek-term">ç½‘æ˜“äº‘éŸ³ä¹</span> ä¸­æœç´¢å¹¶æ·»åŠ åˆ°æ­Œå•ã€‚
                    </p>
                    {% if songs %}
                    <ul class="song-list">
                        {% for interval_name, song_list in songs.items() %}
                        <li class="song-category">
                            <strong>{{ interval_name }}ï¼š</strong>
                            <ul style="margin-top: 8px; margin-left: 20px;">
                                {% for song in song_list %}
                                <li class="song-item">
                                    <a href="{{ song.url }}" target="_blank">{{ song.name }}</a>
                                </li>
                                {% endfor %}
                            </ul>
                        </li>
                        {% endfor %}
                    </ul>
                    {% else %}
                    <p style="color: var(--text-secondary);">æ­Œæ›²åˆ—è¡¨åŠ è½½ä¸­...</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </aside>

    <!-- å³ä¾§ä¸»ç»ƒä¹ åŒºåŸŸ -->
    <main class="main-practice-area">
        <div class="practice-header">
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                {% if exercise_info.icon.startswith('minecrafts/') or exercise_info.icon.startswith('minecraft/') %}
                    <img src="{{ url_for('static', filename='images/' + exercise_info.icon) }}" alt="{{ exercise_info.name }}" style="width: 32px; height: 32px; image-rendering: pixelated;" onerror="this.style.display='none'; this.nextElementSibling.style.display='inline';">
                    <span style="display:none; font-size: 24px;">ğŸµ</span>
                {% else %}
                    <span style="font-size: 24px;">{{ exercise_info.icon }}</span>
                {% endif %}
                <h1>{{ exercise_info.name }}</h1>
                <span class="geek-badge" style="font-size: 11px; padding: 4px 8px; background: var(--hf-primary-light); color: var(--hf-primary); border-radius: 12px; font-weight: 500;">
                    {{ exercise_info.name_en }}
                </span>
            </div>
            <p>{{ exercise_info.description }}</p>
        </div>

        {% if not current_user.is_authenticated %}
        <div class="auth-notice">
            <p>âš ï¸ æ‚¨å½“å‰æœªç™»å½•ï¼Œç»ƒä¹ è®°å½•ä¸ä¼šè¢«ä¿å­˜åˆ°æ•°æ®åº“ã€‚ <a href="{{ url_for('login') }}">ç™»å½•</a>åå¯ä¿å­˜ç»Ÿè®¡ä¿¡æ¯å’Œç»ƒä¹ å†å²ã€‚</p>
        </div>
        {% endif %}
        
        <div class="stats-bar">
            <div class="stat-item">
                <span class="stat-label">è¿›åº¦</span>
                <span class="stat-value" id="progress">0/20</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">å¾—åˆ†</span>
                <span class="stat-value" id="score">0</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">å‡†ç¡®ç‡</span>
                <span class="stat-value" id="accuracy">0%</span>
            </div>
        </div>

        <div class="question-area" id="question-area">
            <div class="loading-state">
                <div class="loading-spinner"></div>
                <p>æ­£åœ¨åŠ è½½é¢˜ç›®...</p>
            </div>
        </div>
    </main>
</div>

<script src="{{ url_for('static', filename='js/practice.js') }}"></script>
{% endblock %}

