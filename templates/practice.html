{% extends "base.html" %}

{% block title %}{{ exercise_info.name }} - openEar{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/practice.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/exercise-openear-style.css') }}">
{% endblock %}

{% block content %}
<div class="practice-layout">
    <!-- ä¸»ç»ƒä¹ åŒºåŸŸ -->
    <main class="main-practice-area">
        <div class="practice-header">
            <div class="practice-header-title-row">
                <span style="font-size: 24px;">{{ exercise_info.icon }}</span>
                <h1 style="margin: 0; display: inline-block;">{{ exercise_info.name }}</h1>
                <span class="geek-badge" style="font-size: 11px; padding: 4px 8px; background: var(--hf-primary-light); color: var(--hf-primary); border-radius: 12px; font-weight: 500; margin-left: 8px;">
                    {{ exercise_info.name_en }}
                </span>
            </div>
            <p style="margin-top: 8px; margin-bottom: 0;">{{ exercise_info.description }}</p>
        </div>

        {% if not current_user.is_authenticated %}
        <div class="auth-notice">
            <p>âš ï¸ æ‚¨å½“å‰æœªç™»å½•ï¼Œç»ƒä¹ è®°å½•ä¸ä¼šè¢«ä¿å­˜åˆ°æ•°æ®åº“ã€‚ <a href="{{ url_for('login') }}">ç™»å½•</a>åå¯ä¿å­˜ç»Ÿè®¡ä¿¡æ¯å’Œç»ƒä¹ å†å²ã€‚</p>
        </div>
        {% endif %}
        
        <div class="question-area" id="question-area">
            <div class="loading-state">
                <div class="loading-spinner"></div>
                <p>æ­£åœ¨åŠ è½½é¢˜ç›®...</p>
            </div>
        </div>

        <!-- ç­”æ¡ˆæŒ‰é’®åŒºåŸŸ -->
        <div class="exercise-answers-layout" id="answers-layout">
            <!-- ç­”æ¡ˆæŒ‰é’®å°†åŠ¨æ€æ’å…¥è¿™é‡Œ -->
            <!-- æ“ä½œæŒ‰é’®åŒºåŸŸ -->
            <div class="exercise-actions-container">
                <button class="action-btn" id="btn-repeat" disabled>
                    <span class="action-icon">ğŸ”„</span>
                    <span class="action-text">é‡å¤</span>
                </button>
                <button class="action-btn action-btn-primary" id="btn-next" disabled>
                    <span class="action-text">ä¸‹ä¸€é¢˜</span>
                </button>
            </div>
        </div>
    </main>

    <!-- å³ä¾§è¾¹æ  -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-resizer" id="sidebar-resizer"></div>
        <div class="sidebar-header">
            <div class="sidebar-tabs">
                <button class="sidebar-tab active" data-tab="settings">âš™ï¸ è®¾ç½®</button>
                <button class="sidebar-tab" data-tab="explanation">ğŸ’¡ AIç§˜ç±</button>
            </div>
        </div>

        <div class="sidebar-content">
            <!-- Settings æ ‡ç­¾é¡µ -->
            <div class="tab-content active" id="settings-tab">
                <div class="sidebar-section">
                    <h3>è®¾ç½®</h3>
                    <form id="settings-form" class="settings-form">
                        {% if exercise_type == 'interval' %}
                        <div class="form-group">
                            <label>é€‰æ‹©éŸ³ç¨‹ï¼š</label>
                            <div class="checkbox-group">
                                {% for semitone, interval in intervals.items() %}
                                <label class="checkbox-item">
                                    <input type="checkbox" name="intervals" value="{{ interval.name }}" checked>
                                    <span>{{ interval.cn }}</span>
                                </label>
                                {% endfor %}
                            </div>
                            <div style="margin-top: 12px;">
                                <label class="checkbox-item">
                                    <input type="checkbox" id="select-all-intervals">
                                    <strong>å…¨é€‰</strong>
                                </label>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>â†•ï¸ æ–¹å‘ï¼š</label>
                            <div class="checkbox-group">
                                <label class="checkbox-item">
                                    <input type="checkbox" name="directions" value="up" checked>
                                    <span>ä¸Šè¡Œ</span>
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="directions" value="down" checked>
                                    <span>ä¸‹è¡Œ</span>
                                </label>
                            </div>
                        </div>
                        {% elif exercise_type == 'scale_degree' %}
                        <div class="form-group">
                            <label>ğŸ¼ é€‰æ‹©éŸ³é˜¶ï¼š</label>
                            <select name="scale_type" class="form-select">
                                {% for scale_key, scale_info in scales.items() %}
                                <option value="{{ scale_key }}" {% if scale_key == 'major' %}selected{% endif %}>
                                    {{ scale_info.name }} ({{ scale_info.name_en }})
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group">
                            <label>ğŸ¹ é€‰æ‹©è°ƒæ€§ï¼š</label>
                            <select name="key" class="form-select">
                                {% for key in keys %}
                                <option value="{{ key }}" {% if key == 'C' %}selected{% endif %}>{{ key }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group">
                            <label>ğŸšï¸ èµ·å§‹å…«åº¦ï¼š</label>
                            <select name="octave" class="form-select">
                                <option value="3">3</option>
                                <option value="4" selected>4</option>
                                <option value="5">5</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>ğŸ¹ å…«åº¦èŒƒå›´ï¼š</label>
                            <select name="octave_range" class="form-select">
                                <option value="1" selected>ä¸€ä¸ªå…«åº¦</option>
                                <option value="2">ä¸¤ä¸ªå…«åº¦</option>
                            </select>
                            <p style="font-size: 11px; color: var(--hf-text-tertiary); margin-top: 4px;">
                                ä¸¤ä¸ªå…«åº¦æ—¶ï¼Œé¢˜ç›®å¯èƒ½åŒ…å«ç¬¬äºŒä¸ªå…«åº¦çš„éŸ³ï¼ˆå¦‚9éŸ³ã€10éŸ³ç­‰ï¼‰
                            </p>
                        </div>
                        {% elif exercise_type == 'chord_quality' %}
                        <div class="form-group">
                            <label>ğŸ¹ é€‰æ‹©è°ƒæ€§ï¼š</label>
                            <select name="key" class="form-select">
                                {% for key in keys %}
                                <option value="{{ key }}" {% if key == 'C' %}selected{% endif %}>{{ key }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group">
                            <label>ğŸ¼ é€‰æ‹©å’Œå¼¦ç±»å‹ï¼š</label>
                            <div class="checkbox-group">
                                {% for chord_key, chord_info in chord_types.items() %}
                                <label class="checkbox-item">
                                    <input type="checkbox" name="chord_types" value="{{ chord_key }}" 
                                           {% if chord_key in ['major', 'minor', 'diminished', 'dominant7th', 'major7th', 'minor7th'] %}checked{% endif %}>
                                    <span>{{ chord_info.cn }}</span>
                                </label>
                                {% endfor %}
                            </div>
                            <div style="margin-top: 12px;">
                                <label class="checkbox-item">
                                    <input type="checkbox" id="select-all-chords">
                                    <strong>å…¨é€‰</strong>
                                </label>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>ğŸµ é€‰æ‹©å’Œå¼¦çº§æ•°ï¼š</label>
                            <div class="checkbox-group">
                                {% for roman in roman_numerals %}
                                <label class="checkbox-item">
                                    <input type="checkbox" name="roman_numerals" value="{{ roman }}" {% if roman == 'I' %}checked{% endif %}>
                                    <span>{{ roman }}</span>
                                </label>
                                {% endfor %}
                            </div>
                            <div style="margin-top: 12px;">
                                <label class="checkbox-item">
                                    <input type="checkbox" id="select-all-roman">
                                    <strong>å…¨é€‰</strong>
                                </label>
                            </div>
                        </div>
                        {% endif %}
                        <div class="form-group">
                            <label>ğŸ”¢ é¢˜ç›®æ•°é‡ï¼š</label>
                            <select name="total_questions" class="form-select">
                                <option value="10">10é¢˜</option>
                                <option value="20" selected>20é¢˜</option>
                                <option value="30">30é¢˜</option>
                                <option value="50">50é¢˜</option>
                            </select>
                        </div>
                        <button type="button" class="btn" onclick="applySettings()">
                            <span>ğŸ’¾</span> åº”ç”¨è®¾ç½®
                        </button>
                    </form>
                </div>
            </div>

            <!-- Explanation æ ‡ç­¾é¡µ -->
            <div class="tab-content" id="explanation-tab">
                <div class="sidebar-section">
                    <h3>ğŸ’¡ AIç§˜ç±</h3>
                    
                    {% if exercise_type == 'interval' %}
                    <!-- éŸ³ç¨‹é€‰æ‹©ä¸‹æ‹‰æ¡†ï¼ˆå¤šé€‰ï¼‰ -->
                    <div class="form-group ai-secret-select-group">
                        <label>é€‰æ‹©éŸ³ç¨‹æŸ¥çœ‹å‚è€ƒæ­Œæ›²ï¼š</label>
                        <div class="custom-multiselect">
                            <div class="custom-multiselect-trigger" id="interval-select-trigger">
                                <span class="custom-multiselect-text">è¯·é€‰æ‹©éŸ³ç¨‹</span>
                                <span class="custom-multiselect-arrow">â–¼</span>
                            </div>
                            <div class="custom-multiselect-dropdown" id="interval-select-dropdown">
                                <div class="custom-multiselect-actions">
                                    <button type="button" class="custom-multiselect-action-btn" id="select-all-intervals-ai">å…¨é€‰</button>
                                    <button type="button" class="custom-multiselect-action-btn" id="deselect-all-intervals-ai">åé€‰</button>
                                </div>
                                <div class="custom-multiselect-options" id="interval-select-options">
                                    {% for semitone, interval in intervals.items() %}
                                    <label class="custom-multiselect-option">
                                        <input type="checkbox" value="{{ interval.name }}" data-label="{{ interval.cn }}" checked>
                                        <span>{{ interval.cn }}</span>
                                    </label>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% elif exercise_type == 'scale_degree' %}
                    <!-- éŸ³é˜¶é€‰æ‹©ä¸‹æ‹‰æ¡†ï¼ˆå¤šé€‰ï¼‰ -->
                    <div class="form-group ai-secret-select-group">
                        <label>é€‰æ‹©éŸ³é˜¶æŸ¥çœ‹å‚è€ƒæ­Œæ›²ï¼š</label>
                        <div class="custom-multiselect">
                            <div class="custom-multiselect-trigger" id="scale-select-trigger">
                                <span class="custom-multiselect-text">è¯·é€‰æ‹©éŸ³é˜¶</span>
                                <span class="custom-multiselect-arrow">â–¼</span>
                            </div>
                            <div class="custom-multiselect-dropdown" id="scale-select-dropdown">
                                <div class="custom-multiselect-actions">
                                    <button type="button" class="custom-multiselect-action-btn" id="select-all-scales-ai">å…¨é€‰</button>
                                    <button type="button" class="custom-multiselect-action-btn" id="deselect-all-scales-ai">åé€‰</button>
                                </div>
                                <div class="custom-multiselect-options" id="scale-select-options">
                                    {% for scale_key, scale_info in scales.items() %}
                                    <label class="custom-multiselect-option">
                                        <input type="checkbox" value="{{ scale_key }}" data-label="{{ scale_info.name }} ({{ scale_info.name_en }})" {% if scale_key == 'major' %}checked{% endif %}>
                                        <span>{{ scale_info.name }} ({{ scale_info.name_en }})</span>
                                    </label>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% elif exercise_type == 'chord_quality' %}
                    <!-- å’Œå¼¦ç±»å‹é€‰æ‹©ä¸‹æ‹‰æ¡†ï¼ˆå¤šé€‰ï¼‰ -->
                    <div class="form-group ai-secret-select-group">
                        <label>é€‰æ‹©å’Œå¼¦ç±»å‹æŸ¥çœ‹å‚è€ƒæ­Œæ›²ï¼š</label>
                        <div class="custom-multiselect">
                            <div class="custom-multiselect-trigger" id="chord-select-trigger">
                                <span class="custom-multiselect-text">è¯·é€‰æ‹©å’Œå¼¦ç±»å‹</span>
                                <span class="custom-multiselect-arrow">â–¼</span>
                            </div>
                            <div class="custom-multiselect-dropdown" id="chord-select-dropdown">
                                <div class="custom-multiselect-actions">
                                    <button type="button" class="custom-multiselect-action-btn" id="select-all-chords-ai">å…¨é€‰</button>
                                    <button type="button" class="custom-multiselect-action-btn" id="deselect-all-chords-ai">åé€‰</button>
                                </div>
                                <div class="custom-multiselect-options" id="chord-select-options">
                                    {% for chord_key, chord_info in chord_types.items() %}
                                    <label class="custom-multiselect-option">
                                        <input type="checkbox" value="{{ chord_key }}" data-label="{{ chord_info.cn }} ({{ chord_info.name }})" checked>
                                        <span>{{ chord_info.cn }} ({{ chord_info.name }})</span>
                                    </label>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- JSONæ•°æ®æ­Œæ›²å±•ç¤ºåŒºåŸŸ -->
                    <div id="json-songs-container"></div>
                    
                    {% if exercise_type == 'interval' %}
                    <!-- éŸ³ç¨‹æ­Œå•ï¼ˆä»çŸ¥è¯†åº“ï¼‰ -->
                    <div id="interval-songs-kb" style="display: none;">
                        <div id="current-interval-songs">
                            <p style="color: var(--text-secondary); font-size: 12px;">
                                è¯·é€‰æ‹©éŸ³ç¨‹åæŸ¥çœ‹å‚è€ƒæ­Œæ›²
                            </p>
                        </div>
                    </div>
                    {% elif exercise_type == 'scale_degree' %}
                    <!-- éŸ³é˜¶æ­Œå•ï¼ˆä»çŸ¥è¯†åº“ï¼‰ -->
                    <div id="scale-songs-kb" style="display: none;">
                        <div id="current-scale-songs">
                            <p style="color: var(--text-secondary); font-size: 12px;">
                                è¯·é€‰æ‹©éŸ³é˜¶åæŸ¥çœ‹å‚è€ƒæ­Œæ›²
                            </p>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </aside>
</div>

<script src="{{ url_for('static', filename='js/practice.js') }}"></script>

<!-- çŸ¥è¯†åº“æ•°æ® -->
<script>
// å°†çŸ¥è¯†åº“æ•°æ®ä¼ é€’ç»™JavaScript
const intervalsKB = {{ intervals_kb | tojson }};
const scalesKB = {{ scales_kb | tojson }};
// åŠ è½½songsæ•°æ®
let songsData = {{ songs_data | tojson }};
const exerciseType = '{{ exercise_type }}';

// è°ƒè¯•ä¿¡æ¯
console.log('çŸ¥è¯†åº“æ•°æ®åŠ è½½:', {
    intervals: Object.keys(intervalsKB).length,
    scales: Object.keys(scalesKB).length,
    intervalsKB: intervalsKB,
    scalesKB: scalesKB,
    songsData: songsData
});

// æ›´æ–°éŸ³ç¨‹çŸ¥è¯†åº“ä¿¡æ¯ï¼ˆæ”¯æŒå¤šé€‰ï¼‰
function updateIntervalKB() {
    const checkedBoxes = document.querySelectorAll('input[name="intervals"]:checked');
    const infoSection = document.getElementById('interval-kb-section');
    const infoDiv = document.getElementById('current-interval-info');
    const songsDiv = document.getElementById('current-interval-songs');
    const songsSection = document.getElementById('interval-songs-kb');
    
    if (checkedBoxes.length === 0) {
        // æ²¡æœ‰é€‰ä¸­çš„éŸ³ç¨‹ï¼Œéšè—æ˜¾ç¤º
        if (infoSection) infoSection.style.display = 'none';
        if (songsSection) songsSection.style.display = 'none';
        return;
    }
    
    // æ”¶é›†æ‰€æœ‰é€‰ä¸­éŸ³ç¨‹çš„ä¿¡æ¯
    const intervalsInfo = [];
    const allSongs = [];
    
    checkedBoxes.forEach(checkbox => {
        const intervalName = checkbox.value;
        const kbInfo = intervalsKB[intervalName];
        if (kbInfo) {
            intervalsInfo.push(kbInfo);
            if (kbInfo.songs && kbInfo.songs.length > 0) {
                allSongs.push(...kbInfo.songs);
            }
        }
    });
    
    if (intervalsInfo.length === 0) {
        // æ²¡æœ‰æ‰¾åˆ°çŸ¥è¯†åº“ä¿¡æ¯
        if (infoSection) infoSection.style.display = 'none';
        if (songsSection) songsSection.style.display = 'none';
        return;
    }
    
    // æ˜¾ç¤ºè¯´æ˜ï¼ˆå¤šä¸ªéŸ³ç¨‹ä¸€èµ·æ˜¾ç¤ºï¼‰
    if (infoSection && infoDiv) {
        infoSection.style.display = 'block';
        const intervalsHtml = intervalsInfo.map(kbInfo => {
            const directionText = kbInfo.direction === 'descending' ? 'ï¼ˆä¸‹è¡Œï¼‰' : 'ï¼ˆä¸Šè¡Œï¼‰';
            return `
                <div style="margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid var(--border-color);">
                    <div style="margin-bottom: 12px;">
                        <strong style="color: var(--hf-primary);">${kbInfo.name_zh || kbInfo.name_en}${directionText}</strong>
                        <span style="color: var(--text-secondary); font-size: 11px; margin-left: 8px;">
                            ${kbInfo.name_en} ${kbInfo.direction === 'descending' ? '(descending)' : '(ascending)'}
                        </span>
                    </div>
                    <p style="font-size: 13px; line-height: 1.6; color: var(--text-primary);">
                        ${kbInfo.characteristics_zh || 'æš‚æ— è¯´æ˜'}
                    </p>
                </div>
            `;
        }).join('');
        
        infoDiv.innerHTML = intervalsHtml;
    }
    
    // æ˜¾ç¤ºæ­Œå•ï¼ˆåˆå¹¶æ‰€æœ‰é€‰ä¸­éŸ³ç¨‹çš„æ­Œæ›²ï¼‰
    if (songsSection && songsDiv) {
        if (allSongs.length > 0) {
            // å»é‡
            const uniqueSongs = [...new Set(allSongs)];
            songsSection.style.display = 'block';
            songsDiv.innerHTML = `
                <ul class="song-list" style="margin-top: 8px;">
                    ${uniqueSongs.map(song => `
                        <li class="song-item" style="margin-bottom: 6px; font-size: 12px;">
                            ${song}
                        </li>
                    `).join('')}
                </ul>
            `;
        } else {
            songsDiv.innerHTML = '<p style="color: var(--text-secondary); font-size: 12px;">æš‚æ— å‚è€ƒæ­Œæ›²</p>';
        }
    }
}

// æ›´æ–°éŸ³é˜¶çŸ¥è¯†åº“ä¿¡æ¯
function updateScaleKB(scaleKey) {
    const kbInfo = scalesKB[scaleKey];
    const infoDiv = document.getElementById('current-scale-info');
    const songsDiv = document.getElementById('current-scale-songs');
    
    if (kbInfo) {
        // æ˜¾ç¤ºè¯´æ˜
        if (infoDiv) {
            infoDiv.innerHTML = `
                <div style="margin-bottom: 12px;">
                    <strong style="color: var(--hf-primary);">${kbInfo.name_zh || kbInfo.name_en}</strong>
                    <span style="color: var(--text-secondary); font-size: 11px; margin-left: 8px;">
                        ${kbInfo.name_en}
                    </span>
                </div>
                <p style="font-size: 13px; line-height: 1.6; color: var(--text-primary);">
                    ${kbInfo.characteristics_zh || 'æš‚æ— è¯´æ˜'}
                </p>
            `;
        }
        
        // æ˜¾ç¤ºæ­Œå•
        if (songsDiv) {
            if (kbInfo.songs && kbInfo.songs.length > 0) {
                songsDiv.innerHTML = `
                    <div style="margin-bottom: 8px;">
                        <strong style="color: var(--hf-primary);">${kbInfo.name_zh || kbInfo.name_en}</strong>
                    </div>
                    <ul class="song-list" style="margin-top: 8px;">
                        ${kbInfo.songs.map(song => `
                            <li class="song-item" style="margin-bottom: 6px; font-size: 12px;">
                                ${song}
                            </li>
                        `).join('')}
                    </ul>
                `;
            } else {
                songsDiv.innerHTML = '<p style="color: var(--text-secondary); font-size: 12px;">æš‚æ— å‚è€ƒæ­Œæ›²</p>';
            }
        }
    } else {
        if (infoDiv) {
            infoDiv.innerHTML = '<p style="color: var(--text-secondary); font-size: 12px;">è¯·é€‰æ‹©éŸ³é˜¶åæŸ¥çœ‹è¯¦ç»†ä¿¡æ¯</p>';
        }
        if (songsDiv) {
            songsDiv.innerHTML = '<p style="color: var(--text-secondary); font-size: 12px;">è¯·é€‰æ‹©éŸ³é˜¶åæŸ¥çœ‹å‚è€ƒæ­Œæ›²</p>';
        }
    }
}

// æ¸²æŸ“å•ä¸ªæ­Œæ›²å¡ç‰‡
function renderSongCard(song, index, timestamp) {
    // ä¼˜å…ˆä½¿ç”¨scoreå­—æ®µï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨functional_score
    const scoreUrl = (song.score && song.score.trim() !== '') 
        ? song.score 
        : (song.functional_score && song.functional_score.trim() !== '') 
            ? song.functional_score 
            : null;
    const hasScore = scoreUrl !== null;
    const hasAudio = song.audio && song.audio.trim() !== '';
    const audioId = `audio-${exerciseType}-${timestamp}-${index}`;
    
    return `
        <div class="song-item-card" style="margin-bottom: 16px; padding: 12px; background: var(--bg-secondary, #f9fafb); border: 1px solid var(--border, #e5e7eb); border-radius: 6px; overflow: hidden; word-wrap: break-word;">
            <div style="margin-bottom: 8px;">
                <strong style="color: var(--text-primary, #1f2937); font-size: 13px; display: block;">${song.song_name || 'æœªçŸ¥æ­Œæ›²'}</strong>
                ${song.artist ? `<span style="color: var(--text-secondary, #6b7280); font-size: 12px; display: block; margin-top: 4px;">${song.artist}</span>` : ''}
            </div>
            ${song.description ? `
                <p style="font-size: 12px; line-height: 1.5; color: var(--text-primary, #1f2937); margin-bottom: 8px; word-wrap: break-word;">
                    ${song.description}
                </p>
            ` : ''}
            ${hasScore ? `
                <div style="margin-bottom: 8px;">
                    <a href="${scoreUrl.startsWith('http') ? scoreUrl : `/static/${scoreUrl}`}" target="_blank" style="font-size: 12px; color: var(--hf-primary, #3b82f6); text-decoration: none; display: inline-flex; align-items: center; gap: 4px;">
                        ğŸ“„ æŸ¥çœ‹ä¹è°±
                    </a>
                </div>
            ` : ''}
            ${hasAudio ? `
                <div style="margin-top: 8px; width: 100%;">
                    <audio id="${audioId}" controls style="width: 100%; height: 32px; max-width: 100%;" data-audio-src="${song.audio}">
                        æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒéŸ³é¢‘æ’­æ”¾ã€‚
                    </audio>
                </div>
            ` : ''}
        </div>
    `;
}

// æ¸²æŸ“æ­Œæ›²åˆ—è¡¨ï¼ˆæ”¯æŒåˆ†ç»„æ˜¾ç¤ºï¼‰
function renderSongsList(songs, groupedData = null) {
    // å¦‚æœæä¾›äº†åˆ†ç»„æ•°æ®ï¼ŒæŒ‰åˆ†ç»„æ˜¾ç¤º
    if (groupedData && Object.keys(groupedData).length > 0) {
        const timestamp = Date.now();
        let globalIndex = 0;
        let html = '';
        
        Object.keys(groupedData).forEach((typeName, groupIndex) => {
            const songs = groupedData[typeName];
            if (!songs || songs.length === 0) return;
            
            // æ·»åŠ åˆ†å‰²çº¿å’Œæ ‡é¢˜ï¼ˆç¬¬ä¸€ä¸ªåˆ†ç»„å‰ä¸åŠ åˆ†å‰²çº¿ï¼‰
            if (groupIndex > 0) {
                html += `
                    <div style="margin: 24px 0 16px 0; border-top: 2px solid var(--border, #e5e7eb);"></div>
                `;
            }
            
            // æ·»åŠ ç±»å‹æ ‡é¢˜
            html += `
                <div style="margin-bottom: 12px;">
                    <h4 style="font-size: 14px; font-weight: 600; color: var(--text-primary, #1f2937); margin: 0;">
                        ${typeName}
                    </h4>
                </div>
            `;
            
            // æ¸²æŸ“è¯¥ç±»å‹ä¸‹çš„æ‰€æœ‰æ­Œæ›²
            songs.forEach((song, songIndex) => {
                html += renderSongCard(song, globalIndex++, timestamp);
            });
        });
        
        return html || '<p style="color: var(--text-secondary, #6b7280); font-size: 12px;">æš‚æ— å‚è€ƒæ­Œæ›²</p>';
    }
    
    // å¦‚æœæ²¡æœ‰åˆ†ç»„æ•°æ®ï¼ŒæŒ‰åŸæ¥çš„æ–¹å¼æ˜¾ç¤ºï¼ˆå‘åå…¼å®¹ï¼‰
    if (!songs || songs.length === 0) {
        return '<p style="color: var(--text-secondary, #6b7280); font-size: 12px;">æš‚æ— å‚è€ƒæ­Œæ›²</p>';
    }
    
    const timestamp = Date.now();
    return songs.map((song, index) => renderSongCard(song, index, timestamp)).join('');
}

// åˆå§‹åŒ–éŸ³é¢‘æ’­æ”¾å™¨ï¼Œé™åˆ¶æ’­æ”¾1åˆ†é’Ÿ
function initAudioPlayers() {
    document.querySelectorAll('audio[data-audio-src]').forEach(audio => {
        // å¦‚æœå·²ç»åˆå§‹åŒ–è¿‡ï¼Œè·³è¿‡
        if (audio.dataset.initialized === 'true') {
            return;
        }
        
        const audioSrc = audio.getAttribute('data-audio-src');
        if (audioSrc && !audio.src) {
            // æ„å»ºéŸ³é¢‘URL
            // audioSrcæ ¼å¼å¯èƒ½æ˜¯ "songs/xxx.mp3" æˆ–å®Œæ•´URL
            let audioUrl;
            let use1minVersion = false;
            
            if (audioSrc.startsWith('http')) {
                audioUrl = audioSrc;
            } else if (audioSrc.startsWith('songs/')) {
                // ä¼˜å…ˆä½¿ç”¨1åˆ†é’Ÿç‰ˆæœ¬ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                const audioPath1min = audioSrc.replace('songs/', 'songs_1min/');
                audioUrl = `/static/audio/${audioPath1min}`;
                use1minVersion = true;
            } else {
                // å…¶ä»–æƒ…å†µï¼Œä¹Ÿæ‹¼æ¥
                audioUrl = `/static/audio/${audioSrc}`;
            }
            
            // ç§»åŠ¨ç«¯ä¼˜åŒ–ï¼šä½¿ç”¨ metadata é¢„åŠ è½½
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            if (isMobile) {
                audio.preload = 'metadata';
            } else {
                audio.preload = 'auto';
            }
            
            // å¦‚æœä½¿ç”¨1åˆ†é’Ÿç‰ˆæœ¬ï¼Œå…ˆæ£€æŸ¥æ˜¯å¦å­˜åœ¨
            if (use1minVersion) {
                const testAudio = new Audio();
                testAudio.src = audioUrl;
                
                const setupAudio = (finalUrl) => {
                    audio.src = finalUrl;
                    audio.dataset.initialized = 'true';
                    
                    // ç›‘å¬åŠ è½½äº‹ä»¶ï¼ˆç§»åŠ¨ç«¯ï¼‰
                    audio.addEventListener('loadstart', function() {
                        // éŸ³é¢‘å¼€å§‹åŠ è½½
                    });
                    
                    audio.addEventListener('loadedmetadata', function() {
                        // å…ƒæ•°æ®åŠ è½½å®Œæˆ
                    });
                    
                    audio.addEventListener('canplay', function() {
                        // éŸ³é¢‘å¯ä»¥æ’­æ”¾
                    });
                    
                    // ç›‘å¬é”™è¯¯äº‹ä»¶
                    audio.addEventListener('error', function(e) {
                        console.error('éŸ³é¢‘åŠ è½½å¤±è´¥:', finalUrl, e);
                        // ç§»åŠ¨ç«¯é”™è¯¯å¤„ç†
                        if (this.error) {
                            console.warn('éŸ³é¢‘é”™è¯¯ä»£ç :', this.error.code);
                        }
                    });
                    
                    // ç›‘å¬timeupdateäº‹ä»¶ï¼Œé™åˆ¶æ’­æ”¾1åˆ†é’Ÿï¼ˆå¦‚æœä½¿ç”¨åŸæ–‡ä»¶ï¼‰
                    if (!use1minVersion) {
                        audio.addEventListener('timeupdate', function() {
                            if (this.currentTime >= 60) {
                                this.pause();
                                this.currentTime = 60;
                            }
                        });
                    }
                    
                    // ç§»åŠ¨ç«¯ï¼šç”¨æˆ·ç‚¹å‡»æ’­æ”¾æ—¶æ‰åŠ è½½å®Œæ•´éŸ³é¢‘
                    if (isMobile) {
                        audio.addEventListener('play', function() {
                            if (this.readyState < 2) {
                                this.load();
                            }
                        }, { once: true });
                    }
                };
                
                // æ£€æŸ¥1åˆ†é’Ÿç‰ˆæœ¬æ˜¯å¦å­˜åœ¨
                testAudio.addEventListener('error', function() {
                    // å¦‚æœ1åˆ†é’Ÿç‰ˆæœ¬ä¸å­˜åœ¨ï¼Œå›é€€åˆ°åŸæ–‡ä»¶
                    const originalUrl = `/static/audio/${audioSrc}`;
                    use1minVersion = false;
                    setupAudio(originalUrl);
                }, { once: true });
                
                testAudio.addEventListener('loadedmetadata', function() {
                    // 1åˆ†é’Ÿç‰ˆæœ¬å­˜åœ¨ï¼Œä½¿ç”¨å®ƒ
                    setupAudio(audioUrl);
                }, { once: true });
                
                // å¼€å§‹æ£€æŸ¥
                testAudio.load();
            } else {
                // ç›´æ¥ä½¿ç”¨åŸæ–‡ä»¶
                audio.src = audioUrl;
                audio.dataset.initialized = 'true';
                
                // ç›‘å¬åŠ è½½äº‹ä»¶ï¼ˆç§»åŠ¨ç«¯ï¼‰
                audio.addEventListener('loadstart', function() {
                    // éŸ³é¢‘å¼€å§‹åŠ è½½
                });
                
                audio.addEventListener('loadedmetadata', function() {
                    // å…ƒæ•°æ®åŠ è½½å®Œæˆ
                });
                
                audio.addEventListener('canplay', function() {
                    // éŸ³é¢‘å¯ä»¥æ’­æ”¾
                });
                
                // ç›‘å¬é”™è¯¯äº‹ä»¶
                audio.addEventListener('error', function(e) {
                    console.error('éŸ³é¢‘åŠ è½½å¤±è´¥:', audioUrl, e);
                    // ç§»åŠ¨ç«¯é”™è¯¯å¤„ç†
                    if (this.error) {
                        console.warn('éŸ³é¢‘é”™è¯¯ä»£ç :', this.error.code);
                    }
                });
                
                // ç›‘å¬timeupdateäº‹ä»¶ï¼Œé™åˆ¶æ’­æ”¾1åˆ†é’Ÿ
                audio.addEventListener('timeupdate', function() {
                    if (this.currentTime >= 60) {
                        this.pause();
                        this.currentTime = 60;
                    }
                });
                
                // ç§»åŠ¨ç«¯ï¼šç”¨æˆ·ç‚¹å‡»æ’­æ”¾æ—¶æ‰åŠ è½½å®Œæ•´éŸ³é¢‘
                if (isMobile) {
                    audio.addEventListener('play', function() {
                        if (this.readyState < 2) {
                            this.load();
                        }
                    }, { once: true });
                }
            }
        }
    });
}

// æ›´æ–°è‡ªå®šä¹‰ä¸‹æ‹‰æ¡†æ˜¾ç¤ºçš„æ–‡æœ¬
function updateCustomSelectText(triggerId, optionsContainerId) {
    const trigger = document.getElementById(triggerId);
    const optionsContainer = document.getElementById(optionsContainerId);
    if (!trigger || !optionsContainer) return;
    
    const checkedBoxes = optionsContainer.querySelectorAll('input[type="checkbox"]:checked');
    const textSpan = trigger.querySelector('.custom-multiselect-text');
    
    if (checkedBoxes.length === 0) {
        textSpan.textContent = 'è¯·é€‰æ‹©';
    } else if (checkedBoxes.length === 1) {
        textSpan.textContent = checkedBoxes[0].dataset.label || checkedBoxes[0].value;
    } else {
        textSpan.textContent = `å·²é€‰æ‹© ${checkedBoxes.length} é¡¹`;
    }
}

// è·å–è‡ªå®šä¹‰ä¸‹æ‹‰æ¡†é€‰ä¸­çš„å€¼
function getCustomSelectValues(optionsContainerId) {
    const optionsContainer = document.getElementById(optionsContainerId);
    if (!optionsContainer) return [];
    
    const checkedBoxes = optionsContainer.querySelectorAll('input[type="checkbox"]:checked');
    return Array.from(checkedBoxes).map(cb => cb.value);
}

// æ›´æ–°JSONæ­Œæ›²æ˜¾ç¤º
function updateJsonSongsDisplay() {
    const container = document.getElementById('json-songs-container');
    if (!container || !songsData) return;
    
    // æ ¹æ®ç»ƒä¹ ç±»å‹è·å–songsæ•°æ®
    let groupedSongs = {};
    
    if (exerciseType === 'interval') {
        // è·å–é€‰ä¸­çš„éŸ³ç¨‹ï¼ˆä¼˜å…ˆä½¿ç”¨AIç§˜ç±é¡µé¢çš„è‡ªå®šä¹‰ä¸‹æ‹‰æ¡†ï¼Œå¦åˆ™ä½¿ç”¨è®¾ç½®é¡µé¢çš„å¤é€‰æ¡†ï¼‰
        let selectedIntervals = getCustomSelectValues('interval-select-options');
        
        // å¦‚æœæ²¡æœ‰é€‰ä¸­çš„ï¼Œä½¿ç”¨è®¾ç½®é¡µé¢çš„å¤é€‰æ¡†
        if (selectedIntervals.length === 0) {
            const checkedBoxes = document.querySelectorAll('input[name="intervals"]:checked');
            selectedIntervals = Array.from(checkedBoxes).map(cb => cb.value);
        }
        
        if (selectedIntervals.length === 0) {
            container.innerHTML = '<p style="color: var(--text-secondary, #6b7280); font-size: 12px;">è¯·é€‰æ‹©éŸ³ç¨‹åæŸ¥çœ‹å‚è€ƒæ­Œæ›²</p>';
            return;
        }
        
        // éŸ³ç¨‹åç§°æ˜ å°„
        const intervalNames = {
            'minor_second': 'å°äºŒåº¦',
            'major_second': 'å¤§äºŒåº¦',
            'minor_third': 'å°ä¸‰åº¦',
            'major_third': 'å¤§ä¸‰åº¦',
            'perfect_fourth': 'çº¯å››åº¦',
            'tritone': 'ä¸‰å…¨éŸ³',
            'perfect_fifth': 'çº¯äº”åº¦',
            'minor_sixth': 'å°å…­åº¦',
            'major_sixth': 'å¤§å…­åº¦',
            'minor_seventh': 'å°ä¸ƒåº¦',
            'major_seventh': 'å¤§ä¸ƒåº¦',
            'octave': 'å…«åº¦',
            'minor_ninth': 'å°ä¹åº¦',
            'major_ninth': 'å¤§ä¹åº¦',
            'minor_tenth': 'å°ååº¦',
            'eleventh': 'åä¸€åº¦',
            'major_thirteenth': 'å¤§åä¸‰åº¦'
        };
        
        selectedIntervals.forEach(intervalName => {
            if (songsData.interval && songsData.interval[intervalName]) {
                const intervalCnName = intervalNames[intervalName] || intervalName;
                groupedSongs[intervalCnName] = songsData.interval[intervalName];
            }
        });
    } else if (exerciseType === 'scale_degree') {
        // è·å–é€‰ä¸­çš„éŸ³é˜¶ï¼ˆä¼˜å…ˆä½¿ç”¨AIç§˜ç±é¡µé¢çš„è‡ªå®šä¹‰ä¸‹æ‹‰æ¡†ï¼Œå¦åˆ™ä½¿ç”¨è®¾ç½®é¡µé¢çš„ä¸‹æ‹‰æ¡†ï¼‰
        let selectedScales = getCustomSelectValues('scale-select-options');
        
        // å¦‚æœæ²¡æœ‰é€‰ä¸­çš„ï¼Œä½¿ç”¨è®¾ç½®é¡µé¢çš„ä¸‹æ‹‰æ¡†
        if (selectedScales.length === 0) {
            const scaleSelect = document.querySelector('select[name="scale_type"]');
            if (scaleSelect && scaleSelect.value) {
                selectedScales.push(scaleSelect.value);
            } else {
                selectedScales.push('major'); // é»˜è®¤
            }
        }
        
        // éŸ³é˜¶åç§°æ˜ å°„ï¼ˆæ•°æ®æ–‡ä»¶key -> æ˜¾ç¤ºåç§°ï¼‰
        const scaleNames = {
            'major': 'å¤§è°ƒ',
            'ionian': 'ä¼Šå¥¥å°¼äºšè°ƒå¼',
            'natural_minor': 'è‡ªç„¶å°è°ƒ',
            'aeolian': 'çˆ±å¥¥åˆ©äºšè°ƒå¼',
            'harmonic_minor': 'å’Œå£°å°è°ƒ',
            'melodic_minor': 'æ—‹å¾‹å°è°ƒ',
            'dorian': 'å¤šåˆ©äºšè°ƒå¼',
            'mixolydian': 'æ··åˆåˆ©åº•äºšè°ƒå¼',
            'lydian': 'åˆ©åº•äºšè°ƒå¼',
            'phrygian': 'å¼—é‡Œå‡ äºšè°ƒå¼',
            'locrian': 'æ´›å…‹é‡Œäºšè°ƒå¼',
            'pentatonic_major': 'å¤§è°ƒäº”å£°éŸ³é˜¶',
            'pentatonic_minor': 'å°è°ƒäº”å£°éŸ³é˜¶',
            'blues_scale': 'å¸ƒé²æ–¯éŸ³é˜¶',
            'blues': 'å¸ƒé²æ–¯éŸ³é˜¶',
            'whole_tone': 'å…¨éŸ³é˜¶',
            'diminished': 'å‡éŸ³é˜¶'
        };
        
        // æ•°æ®æ–‡ä»¶keyæ˜ å°„ï¼ˆä»£ç ä¸­çš„key -> æ•°æ®æ–‡ä»¶ä¸­çš„keyï¼‰
        const scaleKeyMapping = {
            'major': 'major',
            'ionian': 'ionian',
            'natural_minor': 'natural_minor',
            'aeolian': 'aeolian',
            'harmonic_minor': 'harmonic_minor',
            'melodic_minor': 'melodic_minor',
            'dorian': 'dorian',
            'mixolydian': 'mixolydian',
            'lydian': 'lydian',
            'phrygian': 'phrygian',
            'locrian': 'locrian',
            'pentatonic_major': 'pentatonic_major',
            'pentatonic_minor': 'pentatonic_minor',
            'blues_scale': 'blues_scale',
            'blues': 'blues_scale', // bluesæ˜ å°„åˆ°blues_scale
            'whole_tone': 'whole_tone',
            'diminished': 'diminished'
        };
        
        selectedScales.forEach(scaleKey => {
            // å…ˆå°è¯•ç›´æ¥åŒ¹é…
            let dataKey = scaleKey;
            // å¦‚æœæ˜ å°„è¡¨ä¸­å­˜åœ¨ï¼Œä½¿ç”¨æ˜ å°„
            if (scaleKeyMapping[scaleKey]) {
                dataKey = scaleKeyMapping[scaleKey];
            }
            
            if (songsData.scale_degree && songsData.scale_degree[dataKey]) {
                const scaleCnName = scaleNames[scaleKey] || scaleNames[dataKey] || scaleKey;
                groupedSongs[scaleCnName] = songsData.scale_degree[dataKey];
            }
        });
    } else if (exerciseType === 'chord_quality') {
        // å’Œå¼¦ç»ƒä¹ ï¼šæ ¹æ®AIç§˜ç±è‡ªå®šä¹‰ä¸‹æ‹‰æ¡†çš„é€‰æ‹©è¿‡æ»¤ï¼ˆæ”¯æŒå¤šé€‰ï¼‰
        let selectedChordTypes = getCustomSelectValues('chord-select-options');
        
        // å’Œå¼¦åç§°æ˜ å°„ï¼ˆä»£ç ä¸­çš„key -> æ˜¾ç¤ºåç§°ï¼‰
        const chordNames = {
            'major': 'å¤§ä¸‰å’Œå¼¦',
            'minor': 'å°ä¸‰å’Œå¼¦',
            'diminished': 'å‡ä¸‰å’Œå¼¦',
            'augmented': 'å¢ä¸‰å’Œå¼¦',
            'sus4': 'æŒ‚å››å’Œå¼¦',
            'suspended_fourth': 'æŒ‚å››å’Œå¼¦',
            'sus2': 'æŒ‚äºŒå’Œå¼¦',
            'suspended_second': 'æŒ‚äºŒå’Œå¼¦',
            'major6th': 'å¤§å…­å’Œå¼¦',
            'sixth': 'å¤§å…­å’Œå¼¦',
            'minor6th': 'å°å…­å’Œå¼¦',
            'major7th': 'å¤§ä¸ƒå’Œå¼¦',
            'major_seventh': 'å¤§ä¸ƒå’Œå¼¦',
            'minor7th': 'å°ä¸ƒå’Œå¼¦',
            'minor_seventh': 'å°ä¸ƒå’Œå¼¦',
            'dominant7th': 'å±ä¸ƒå’Œå¼¦',
            'dominant_seventh': 'å±ä¸ƒå’Œå¼¦',
            'diminished7th': 'å‡ä¸ƒå’Œå¼¦',
            'half_diminished7th': 'åŠå‡ä¸ƒå’Œå¼¦',
            'minor_major_seventh': 'å°å¤§ä¸ƒå’Œå¼¦'
        };
        
        // æ•°æ®æ–‡ä»¶keyæ˜ å°„ï¼ˆä»£ç ä¸­çš„key -> æ•°æ®æ–‡ä»¶ä¸­çš„keyï¼‰
        const chordKeyMapping = {
            'major': 'major',
            'minor': 'minor',
            'diminished': 'diminished',
            'augmented': 'augmented',
            'sus4': 'suspended_fourth',
            'suspended_fourth': 'suspended_fourth',
            'sus2': 'suspended_second',
            'suspended_second': 'suspended_second',
            'major6th': 'sixth',
            'sixth': 'sixth',
            'minor6th': 'sixth', // æ³¨æ„ï¼šæ•°æ®æ–‡ä»¶ä¸­å¯èƒ½æ²¡æœ‰å•ç‹¬çš„minor6th
            'major7th': 'major_seventh',
            'major_seventh': 'major_seventh',
            'minor7th': 'minor_seventh',
            'minor_seventh': 'minor_seventh',
            'dominant7th': 'dominant_seventh',
            'dominant_seventh': 'dominant_seventh',
            'diminished7th': 'diminished', // æ³¨æ„ï¼šå¯èƒ½éœ€è¦æ£€æŸ¥
            'half_diminished7th': 'diminished',
            'minor_major_seventh': 'minor_major_seventh'
        };
        
        if (songsData.chord_quality) {
            if (selectedChordTypes.length > 0) {
                // æ˜¾ç¤ºé€‰ä¸­çš„å’Œå¼¦ç±»å‹
                selectedChordTypes.forEach(chordKey => {
                    // å…ˆå°è¯•ç›´æ¥åŒ¹é…
                    let dataKey = chordKey;
                    // å¦‚æœæ˜ å°„è¡¨ä¸­å­˜åœ¨ï¼Œä½¿ç”¨æ˜ å°„
                    if (chordKeyMapping[chordKey]) {
                        dataKey = chordKeyMapping[chordKey];
                    }
                    
                    if (songsData.chord_quality[dataKey]) {
                        const chordCnName = chordNames[chordKey] || chordNames[dataKey] || chordKey;
                        groupedSongs[chordCnName] = songsData.chord_quality[dataKey];
                    }
                });
            } else {
                // æ˜¾ç¤ºæ‰€æœ‰å’Œå¼¦ç±»å‹
                Object.keys(songsData.chord_quality).forEach(key => {
                    const songList = songsData.chord_quality[key];
                    if (Array.isArray(songList) && songList.length > 0) {
                        // å°è¯•æ‰¾åˆ°å¯¹åº”çš„æ˜¾ç¤ºåç§°
                        let displayName = key;
                        for (const [codeKey, dataKey] of Object.entries(chordKeyMapping)) {
                            if (dataKey === key && chordNames[codeKey]) {
                                displayName = chordNames[codeKey];
                                break;
                            }
                        }
                        groupedSongs[displayName] = songList;
                    }
                });
            }
        }
    } else if (songsData[exerciseType]) {
        // å…¶ä»–ç»ƒä¹ ç±»å‹ï¼Œæ˜¾ç¤ºæ‰€æœ‰songs
        Object.keys(songsData[exerciseType]).forEach(key => {
            const songList = songsData[exerciseType][key];
            if (Array.isArray(songList) && songList.length > 0) {
                groupedSongs[key] = songList;
            }
        });
    }
    
    const totalSongs = Object.values(groupedSongs).reduce((sum, songs) => sum + songs.length, 0);
    
    if (totalSongs === 0) {
        container.innerHTML = '<p style="color: var(--text-secondary, #6b7280); font-size: 12px;">æš‚æ— å‚è€ƒæ­Œæ›²</p>';
        return;
    }
    
    // æ¸²æŸ“æ­Œæ›²åˆ—è¡¨ï¼ˆæŒ‰ç±»å‹åˆ†ç»„ï¼‰
    container.innerHTML = renderSongsList(null, groupedSongs);
    // åˆå§‹åŒ–æ–°æ·»åŠ çš„éŸ³é¢‘æ’­æ”¾å™¨
    setTimeout(initAudioPlayers, 50);
}

    // åˆå§‹åŒ–è‡ªå®šä¹‰ä¸‹æ‹‰æ¡†
    function initCustomMultiselect(triggerId, dropdownId, optionsContainerId) {
        const trigger = document.getElementById(triggerId);
        const dropdown = document.getElementById(dropdownId);
        const optionsContainer = document.getElementById(optionsContainerId);
        
        if (!trigger || !dropdown || !optionsContainer) return;
        
        // å­˜å‚¨dropdownIdåˆ°triggerä¸Šï¼Œæ–¹ä¾¿å…³é—­å…¶ä»–ä¸‹æ‹‰æ¡†
        trigger.dataset.dropdownId = dropdownId;
        
        // ç‚¹å‡»è§¦å‘å™¨æ˜¾ç¤º/éšè—æµ®çª—
        trigger.addEventListener('click', function(e) {
            e.stopPropagation();
            const isActive = trigger.classList.contains('active');
            
            // å…³é—­æ‰€æœ‰å…¶ä»–ä¸‹æ‹‰æ¡†
            document.querySelectorAll('.custom-multiselect-trigger').forEach(t => {
                if (t !== trigger && t.dataset.dropdownId) {
                    t.classList.remove('active');
                    const otherDropdown = document.getElementById(t.dataset.dropdownId);
                    if (otherDropdown) {
                        otherDropdown.classList.remove('show');
                    }
                }
            });
            
            if (isActive) {
                trigger.classList.remove('active');
                dropdown.classList.remove('show');
            } else {
                trigger.classList.add('active');
                dropdown.classList.add('show');
            }
        });
        
        // ç‚¹å‡»é€‰é¡¹æ—¶æ›´æ–°æ˜¾ç¤º
        optionsContainer.addEventListener('change', function() {
            updateCustomSelectText(triggerId, optionsContainerId);
            updateJsonSongsDisplay();
        });
        
        // ç‚¹å‡»å¤–éƒ¨å…³é—­æµ®çª—
        document.addEventListener('click', function(e) {
            if (!trigger.contains(e.target) && !dropdown.contains(e.target)) {
                trigger.classList.remove('active');
                dropdown.classList.remove('show');
            }
        });
        
        // åˆå§‹åŒ–æ˜¾ç¤ºæ–‡æœ¬
        updateCustomSelectText(triggerId, optionsContainerId);
    }
    
    // ç›‘å¬éŸ³ç¨‹é€‰æ‹©å˜åŒ–
document.addEventListener('DOMContentLoaded', function() {
    {% if exercise_type == 'interval' %}
    // ç›‘å¬éŸ³ç¨‹å¤é€‰æ¡†å˜åŒ–ï¼ˆè®¾ç½®é¡µé¢ï¼‰
    const intervalCheckboxes = document.querySelectorAll('input[name="intervals"]');
    intervalCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            // é€‰æ‹©å˜åŒ–æ—¶æ›´æ–°æ‰€æœ‰é€‰ä¸­çš„éŸ³ç¨‹
            updateIntervalKB();
            updateJsonSongsDisplay();
        });
    });
    
    // åˆå§‹åŒ–è‡ªå®šä¹‰ä¸‹æ‹‰æ¡†
    initCustomMultiselect('interval-select-trigger', 'interval-select-dropdown', 'interval-select-options');
    
    // å…¨é€‰éŸ³ç¨‹ï¼ˆAIç§˜ç±é¡µé¢ï¼‰
    const selectAllIntervalsAI = document.getElementById('select-all-intervals-ai');
    if (selectAllIntervalsAI) {
        selectAllIntervalsAI.addEventListener('click', function(e) {
            e.stopPropagation();
            const optionsContainer = document.getElementById('interval-select-options');
            if (optionsContainer) {
                optionsContainer.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = true);
                updateCustomSelectText('interval-select-trigger', 'interval-select-options');
                updateJsonSongsDisplay();
            }
        });
    }
    
    // åé€‰éŸ³ç¨‹ï¼ˆAIç§˜ç±é¡µé¢ï¼‰
    const deselectAllIntervalsAI = document.getElementById('deselect-all-intervals-ai');
    if (deselectAllIntervalsAI) {
        deselectAllIntervalsAI.addEventListener('click', function(e) {
            e.stopPropagation();
            const optionsContainer = document.getElementById('interval-select-options');
            if (optionsContainer) {
                optionsContainer.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = !cb.checked);
                updateCustomSelectText('interval-select-trigger', 'interval-select-options');
                updateJsonSongsDisplay();
            }
        });
    }
    
    // é»˜è®¤æ˜¾ç¤ºæ‰€æœ‰é€‰ä¸­çš„éŸ³ç¨‹
    updateIntervalKB();
    updateJsonSongsDisplay();
    {% elif exercise_type == 'scale_degree' %}
    // ç›‘å¬éŸ³é˜¶é€‰æ‹©å˜åŒ–ï¼ˆè®¾ç½®é¡µé¢çš„ä¸‹æ‹‰æ¡†ï¼‰
    const scaleSelect = document.querySelector('select[name="scale_type"]');
    if (scaleSelect) {
        scaleSelect.addEventListener('change', function() {
            updateScaleKB(this.value);
            updateJsonSongsDisplay();
        });
        
        // é»˜è®¤æ˜¾ç¤ºå½“å‰é€‰ä¸­çš„éŸ³é˜¶
        updateScaleKB(scaleSelect.value);
        updateJsonSongsDisplay();
    }
    
    // åˆå§‹åŒ–è‡ªå®šä¹‰ä¸‹æ‹‰æ¡†
    initCustomMultiselect('scale-select-trigger', 'scale-select-dropdown', 'scale-select-options');
    
    // å…¨é€‰éŸ³é˜¶ï¼ˆAIç§˜ç±é¡µé¢ï¼‰
    const selectAllScalesAI = document.getElementById('select-all-scales-ai');
    if (selectAllScalesAI) {
        selectAllScalesAI.addEventListener('click', function(e) {
            e.stopPropagation();
            const optionsContainer = document.getElementById('scale-select-options');
            if (optionsContainer) {
                optionsContainer.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = true);
                updateCustomSelectText('scale-select-trigger', 'scale-select-options');
                updateJsonSongsDisplay();
            }
        });
    }
    
    // åé€‰éŸ³é˜¶ï¼ˆAIç§˜ç±é¡µé¢ï¼‰
    const deselectAllScalesAI = document.getElementById('deselect-all-scales-ai');
    if (deselectAllScalesAI) {
        deselectAllScalesAI.addEventListener('click', function(e) {
            e.stopPropagation();
            const optionsContainer = document.getElementById('scale-select-options');
            if (optionsContainer) {
                optionsContainer.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = !cb.checked);
                updateCustomSelectText('scale-select-trigger', 'scale-select-options');
                updateJsonSongsDisplay();
            }
        });
    }
    {% elif exercise_type == 'chord_quality' %}
    // åˆå§‹åŒ–è‡ªå®šä¹‰ä¸‹æ‹‰æ¡†
    initCustomMultiselect('chord-select-trigger', 'chord-select-dropdown', 'chord-select-options');
    
    // å…¨é€‰å’Œå¼¦ï¼ˆAIç§˜ç±é¡µé¢ï¼‰
    const selectAllChordsAI = document.getElementById('select-all-chords-ai');
    if (selectAllChordsAI) {
        selectAllChordsAI.addEventListener('click', function(e) {
            e.stopPropagation();
            const optionsContainer = document.getElementById('chord-select-options');
            if (optionsContainer) {
                optionsContainer.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = true);
                updateCustomSelectText('chord-select-trigger', 'chord-select-options');
                updateJsonSongsDisplay();
            }
        });
    }
    
    // åé€‰å’Œå¼¦ï¼ˆAIç§˜ç±é¡µé¢ï¼‰
    const deselectAllChordsAI = document.getElementById('deselect-all-chords-ai');
    if (deselectAllChordsAI) {
        deselectAllChordsAI.addEventListener('click', function(e) {
            e.stopPropagation();
            const optionsContainer = document.getElementById('chord-select-options');
            if (optionsContainer) {
                optionsContainer.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = !cb.checked);
                updateCustomSelectText('chord-select-trigger', 'chord-select-options');
                updateJsonSongsDisplay();
            }
        });
    }
    
    // é»˜è®¤æ˜¾ç¤ºæ‰€æœ‰å’Œå¼¦
    updateJsonSongsDisplay();
    {% else %}
    // å…¶ä»–ç»ƒä¹ ç±»å‹ï¼Œç›´æ¥æ˜¾ç¤º
    updateJsonSongsDisplay();
    {% endif %}
    
    // ä½¿ç”¨MutationObserverç›‘å¬DOMå˜åŒ–ï¼Œè‡ªåŠ¨åˆå§‹åŒ–æ–°æ·»åŠ çš„éŸ³é¢‘æ’­æ”¾å™¨
    const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
            if (mutation.addedNodes.length) {
                initAudioPlayers();
            }
        });
    });
    
    // å¼€å§‹è§‚å¯Ÿ
    const jsonSongsContainer = document.getElementById('json-songs-container');
    if (jsonSongsContainer) {
        observer.observe(jsonSongsContainer, {
            childList: true,
            subtree: true
        });
    }
    
    // åˆå§‹åŠ è½½æ—¶ä¹Ÿåˆå§‹åŒ–
    setTimeout(initAudioPlayers, 100);
    
    // ä¿®å¤AIç§˜ç±ä¸‹æ‹‰æ¡†å®½åº¦ï¼ˆä¸practice.jsä¸­çš„å‡½æ•°ä¿æŒä¸€è‡´ï¼‰
    function fixAISelectWidth() {
        const explanationTab = document.getElementById('explanation-tab');
        if (!explanationTab || !explanationTab.classList.contains('active')) {
            return; // tabæ²¡æœ‰æ˜¾ç¤ºï¼Œä¸å¤„ç†
        }
        
        const scaleSelect = document.getElementById('scale-select-ai');
        const intervalSelect = document.getElementById('interval-select-ai');
        const chordSelect = document.getElementById('chord-select-ai');
        const select = scaleSelect || intervalSelect || chordSelect;
        
        if (!select) {
            return;
        }
        
        const sidebar = document.querySelector('.sidebar');
        const sidebarContent = document.querySelector('.sidebar-content');
        
        if (!sidebar || !sidebarContent) {
            return;
        }
        
        // è·å–sidebarçš„å®é™…å®½åº¦
        const sidebarWidth = sidebar.offsetWidth;
        const sidebarContentPadding = 
            (parseInt(window.getComputedStyle(sidebarContent).paddingLeft) || 0) + 
            (parseInt(window.getComputedStyle(sidebarContent).paddingRight) || 0);
        
        const expectedWidth = sidebarWidth - sidebarContentPadding;
        
        // å¦‚æœå®½åº¦ä¸º0æˆ–ä¸è¶³ï¼Œå¼ºåˆ¶ä¿®å¤
        if (select.offsetWidth === 0 || select.offsetWidth < expectedWidth - 10) {
            // å¼ºåˆ¶è®¾ç½®æ‰€æœ‰ç›¸å…³å…ƒç´ çš„å®½åº¦
            const parent = select.parentElement;
            if (parent && parent.classList.contains('ai-secret-select-group')) {
                parent.style.setProperty('width', '100%', 'important');
                parent.style.setProperty('max-width', '100%', 'important');
                parent.style.setProperty('box-sizing', 'border-box', 'important');
            }
            
            // è®¾ç½®ä¸‹æ‹‰æ¡†å®½åº¦
            if (expectedWidth > 0) {
                select.style.setProperty('width', expectedWidth + 'px', 'important');
                select.style.setProperty('max-width', expectedWidth + 'px', 'important');
            } else {
                select.style.setProperty('width', '100%', 'important');
                select.style.setProperty('max-width', '100%', 'important');
            }
            select.style.setProperty('min-width', '0', 'important');
            select.style.setProperty('box-sizing', 'border-box', 'important');
            select.style.setProperty('display', 'block', 'important');
        }
    }
    
    // ç›‘å¬tabåˆ‡æ¢
    const explanationTabBtn = document.querySelector('[data-tab="explanation"]');
    if (explanationTabBtn) {
        explanationTabBtn.addEventListener('click', () => {
            setTimeout(fixAISelectWidth, 150);
        });
    }
    
    // é¡µé¢åŠ è½½å®Œæˆåï¼Œå¦‚æœAIç§˜ç±tabæ˜¯æ¿€æ´»çš„ï¼Œä¿®å¤å®½åº¦
    setTimeout(() => {
        const explanationTab = document.getElementById('explanation-tab');
        if (explanationTab && explanationTab.classList.contains('active')) {
            fixAISelectWidth();
        }
    }, 300);
    
    // ç›‘å¬çª—å£å¤§å°å˜åŒ–
    window.addEventListener('resize', () => {
        setTimeout(fixAISelectWidth, 100);
    });
});
</script>
{% endblock %}

