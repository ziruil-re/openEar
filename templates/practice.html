{% extends "base.html" %}

{% block title %}{{ exercise_info.name }} - openEar{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/practice.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/exercise-openear-style.css') }}">
{% endblock %}

{% block content %}
<div class="practice-layout">
    <!-- ä¸»ç»ƒä¹ åŒºåŸŸ -->
    <main class="main-practice-area">
        <div class="practice-header">
            <div class="practice-header-title-row">
                <span style="font-size: 24px;">{{ exercise_info.icon }}</span>
                <h1 style="margin: 0; display: inline-block;">{{ exercise_info.name }}</h1>
                <span class="geek-badge" style="font-size: 11px; padding: 4px 8px; background: var(--hf-primary-light); color: var(--hf-primary); border-radius: 12px; font-weight: 500; margin-left: 8px;">
                    {{ exercise_info.name_en }}
                </span>
            </div>
            <p style="margin-top: 8px; margin-bottom: 0;">{{ exercise_info.description }}</p>
        </div>

        {% if not current_user.is_authenticated %}
        <div class="auth-notice">
            <p>âš ï¸ æ‚¨å½“å‰æœªç™»å½•ï¼Œç»ƒä¹ è®°å½•ä¸ä¼šè¢«ä¿å­˜åˆ°æ•°æ®åº“ã€‚ <a href="{{ url_for('login') }}">ç™»å½•</a>åå¯ä¿å­˜ç»Ÿè®¡ä¿¡æ¯å’Œç»ƒä¹ å†å²ã€‚</p>
        </div>
        {% endif %}
        
        <div class="stats-bar">
            <div class="stat-item">
                <span class="stat-label">è¿›åº¦</span>
                <span class="stat-value" id="progress">0/20</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">å¾—åˆ†</span>
                <span class="stat-value" id="score">0</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">å‡†ç¡®ç‡</span>
                <span class="stat-value" id="accuracy">0%</span>
            </div>
        </div>

        <div class="question-area" id="question-area">
            <div class="loading-state">
                <div class="loading-spinner"></div>
                <p>æ­£åœ¨åŠ è½½é¢˜ç›®...</p>
            </div>
        </div>

        <!-- ç­”æ¡ˆæŒ‰é’®åŒºåŸŸ -->
        <div class="exercise-answers-layout" id="answers-layout">
            <!-- ç­”æ¡ˆæŒ‰é’®å°†åŠ¨æ€æ’å…¥è¿™é‡Œ -->
            <!-- æ“ä½œæŒ‰é’®åŒºåŸŸ -->
            <div class="exercise-actions-container">
                <button class="action-btn" id="btn-repeat" disabled>
                    <span class="action-icon">ğŸ”„</span>
                    <span class="action-text">é‡å¤</span>
                </button>
                <button class="action-btn action-btn-primary" id="btn-next" disabled>
                    <span class="action-text">ä¸‹ä¸€é¢˜</span>
                </button>
            </div>
        </div>
    </main>

    <!-- å³ä¾§è¾¹æ  -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-resizer" id="sidebar-resizer"></div>
        <div class="sidebar-header">
            <div class="sidebar-tabs">
                <button class="sidebar-tab active" data-tab="settings">âš™ï¸ è®¾ç½®</button>
                <button class="sidebar-tab" data-tab="explanation">ğŸ’¡ AIç§˜ç±</button>
            </div>
        </div>

        <div class="sidebar-content">
            <!-- Settings æ ‡ç­¾é¡µ -->
            <div class="tab-content active" id="settings-tab">
                <div class="sidebar-section">
                    <h3>è®¾ç½®</h3>
                    <form id="settings-form" class="settings-form">
                        {% if exercise_type == 'interval' %}
                        <div class="form-group">
                            <label>é€‰æ‹©éŸ³ç¨‹ï¼š</label>
                            <div class="checkbox-group">
                                {% for semitone, interval in intervals.items() %}
                                <label class="checkbox-item">
                                    <input type="checkbox" name="intervals" value="{{ interval.name }}" checked>
                                    <span>{{ interval.cn }}</span>
                                </label>
                                {% endfor %}
                            </div>
                            <div style="margin-top: 12px;">
                                <label class="checkbox-item">
                                    <input type="checkbox" id="select-all-intervals">
                                    <strong>å…¨é€‰</strong>
                                </label>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>â†•ï¸ æ–¹å‘ï¼š</label>
                            <div class="checkbox-group">
                                <label class="checkbox-item">
                                    <input type="checkbox" name="directions" value="up" checked>
                                    <span>ä¸Šè¡Œ</span>
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="directions" value="down" checked>
                                    <span>ä¸‹è¡Œ</span>
                                </label>
                            </div>
                        </div>
                        {% elif exercise_type == 'scale_degree' %}
                        <div class="form-group">
                            <label>ğŸ¼ é€‰æ‹©éŸ³é˜¶ï¼š</label>
                            <select name="scale_type" class="form-select">
                                {% for scale_key, scale_info in scales.items() %}
                                <option value="{{ scale_key }}" {% if scale_key == 'major' %}selected{% endif %}>
                                    {{ scale_info.name }} ({{ scale_info.name_en }})
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group">
                            <label>ğŸ¹ é€‰æ‹©è°ƒæ€§ï¼š</label>
                            <select name="key" class="form-select">
                                {% for key in keys %}
                                <option value="{{ key }}" {% if key == 'C' %}selected{% endif %}>{{ key }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group">
                            <label>ğŸšï¸ èµ·å§‹å…«åº¦ï¼š</label>
                            <select name="octave" class="form-select">
                                <option value="3">3</option>
                                <option value="4" selected>4</option>
                                <option value="5">5</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>ğŸ¹ å…«åº¦èŒƒå›´ï¼š</label>
                            <select name="octave_range" class="form-select">
                                <option value="1" selected>ä¸€ä¸ªå…«åº¦</option>
                                <option value="2">ä¸¤ä¸ªå…«åº¦</option>
                            </select>
                            <p style="font-size: 11px; color: var(--hf-text-tertiary); margin-top: 4px;">
                                ä¸¤ä¸ªå…«åº¦æ—¶ï¼Œé¢˜ç›®å¯èƒ½åŒ…å«ç¬¬äºŒä¸ªå…«åº¦çš„éŸ³ï¼ˆå¦‚9éŸ³ã€10éŸ³ç­‰ï¼‰
                            </p>
                        </div>
                        {% endif %}
                        <div class="form-group">
                            <label>ğŸ”¢ é¢˜ç›®æ•°é‡ï¼š</label>
                            <select name="total_questions" class="form-select">
                                <option value="10">10é¢˜</option>
                                <option value="20" selected>20é¢˜</option>
                                <option value="30">30é¢˜</option>
                                <option value="50">50é¢˜</option>
                            </select>
                        </div>
                        <button type="button" class="btn" onclick="applySettings()">
                            <span>ğŸ’¾</span> åº”ç”¨è®¾ç½®
                        </button>
                    </form>
                </div>
            </div>

            <!-- Explanation æ ‡ç­¾é¡µ -->
            <div class="tab-content" id="explanation-tab">
                <div class="sidebar-section">
                    <h3>ğŸ’¡ AIç§˜ç±</h3>
                    <p style="font-size: 12px; color: var(--hf-text-tertiary); margin-bottom: 12px;">
                        ğŸ’¡ <strong>Pro Tip:</strong> ä»¥ä¸‹æ­Œæ›²å¯ä»¥å¸®åŠ©æ‚¨æ›´å¥½åœ°è¯†åˆ«éŸ³ç¨‹/éŸ³é˜¶ã€‚å»ºè®®åœ¨ <span class="geek-term">ç½‘æ˜“äº‘éŸ³ä¹</span> ä¸­æœç´¢å¹¶æ·»åŠ åˆ°æ­Œå•ã€‚
                    </p>
                    
                    <!-- JSONæ•°æ®æ­Œæ›²å±•ç¤ºåŒºåŸŸ -->
                    <div id="json-songs-container"></div>
                    
                    {% if exercise_type == 'interval' %}
                    <!-- éŸ³ç¨‹æ­Œå•ï¼ˆä»çŸ¥è¯†åº“ï¼‰ -->
                    <div id="interval-songs-kb" style="display: none;">
                        <div id="current-interval-songs">
                            <p style="color: var(--text-secondary); font-size: 12px;">
                                è¯·é€‰æ‹©éŸ³ç¨‹åæŸ¥çœ‹å‚è€ƒæ­Œæ›²
                            </p>
                        </div>
                    </div>
                    {% elif exercise_type == 'scale_degree' %}
                    <!-- éŸ³é˜¶æ­Œå•ï¼ˆä»çŸ¥è¯†åº“ï¼‰ -->
                    <div id="scale-songs-kb" style="display: none;">
                        <div id="current-scale-songs">
                            <p style="color: var(--text-secondary); font-size: 12px;">
                                è¯·é€‰æ‹©éŸ³é˜¶åæŸ¥çœ‹å‚è€ƒæ­Œæ›²
                            </p>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </aside>
</div>

<script src="{{ url_for('static', filename='js/practice.js') }}"></script>

<!-- çŸ¥è¯†åº“æ•°æ® -->
<script>
// å°†çŸ¥è¯†åº“æ•°æ®ä¼ é€’ç»™JavaScript
const intervalsKB = {{ intervals_kb | tojson }};
const scalesKB = {{ scales_kb | tojson }};
// åŠ è½½songsæ•°æ®
let songsData = {{ songs_data | tojson }};
const exerciseType = '{{ exercise_type }}';

// è°ƒè¯•ä¿¡æ¯
console.log('çŸ¥è¯†åº“æ•°æ®åŠ è½½:', {
    intervals: Object.keys(intervalsKB).length,
    scales: Object.keys(scalesKB).length,
    intervalsKB: intervalsKB,
    scalesKB: scalesKB,
    songsData: songsData
});

// æ›´æ–°éŸ³ç¨‹çŸ¥è¯†åº“ä¿¡æ¯ï¼ˆæ”¯æŒå¤šé€‰ï¼‰
function updateIntervalKB() {
    const checkedBoxes = document.querySelectorAll('input[name="intervals"]:checked');
    const infoSection = document.getElementById('interval-kb-section');
    const infoDiv = document.getElementById('current-interval-info');
    const songsDiv = document.getElementById('current-interval-songs');
    const songsSection = document.getElementById('interval-songs-kb');
    
    if (checkedBoxes.length === 0) {
        // æ²¡æœ‰é€‰ä¸­çš„éŸ³ç¨‹ï¼Œéšè—æ˜¾ç¤º
        if (infoSection) infoSection.style.display = 'none';
        if (songsSection) songsSection.style.display = 'none';
        return;
    }
    
    // æ”¶é›†æ‰€æœ‰é€‰ä¸­éŸ³ç¨‹çš„ä¿¡æ¯
    const intervalsInfo = [];
    const allSongs = [];
    
    checkedBoxes.forEach(checkbox => {
        const intervalName = checkbox.value;
        const kbInfo = intervalsKB[intervalName];
        if (kbInfo) {
            intervalsInfo.push(kbInfo);
            if (kbInfo.songs && kbInfo.songs.length > 0) {
                allSongs.push(...kbInfo.songs);
            }
        }
    });
    
    if (intervalsInfo.length === 0) {
        // æ²¡æœ‰æ‰¾åˆ°çŸ¥è¯†åº“ä¿¡æ¯
        if (infoSection) infoSection.style.display = 'none';
        if (songsSection) songsSection.style.display = 'none';
        return;
    }
    
    // æ˜¾ç¤ºè¯´æ˜ï¼ˆå¤šä¸ªéŸ³ç¨‹ä¸€èµ·æ˜¾ç¤ºï¼‰
    if (infoSection && infoDiv) {
        infoSection.style.display = 'block';
        const intervalsHtml = intervalsInfo.map(kbInfo => {
            const directionText = kbInfo.direction === 'descending' ? 'ï¼ˆä¸‹è¡Œï¼‰' : 'ï¼ˆä¸Šè¡Œï¼‰';
            return `
                <div style="margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid var(--border-color);">
                    <div style="margin-bottom: 12px;">
                        <strong style="color: var(--hf-primary);">${kbInfo.name_zh || kbInfo.name_en}${directionText}</strong>
                        <span style="color: var(--text-secondary); font-size: 11px; margin-left: 8px;">
                            ${kbInfo.name_en} ${kbInfo.direction === 'descending' ? '(descending)' : '(ascending)'}
                        </span>
                    </div>
                    <p style="font-size: 13px; line-height: 1.6; color: var(--text-primary);">
                        ${kbInfo.characteristics_zh || 'æš‚æ— è¯´æ˜'}
                    </p>
                </div>
            `;
        }).join('');
        
        infoDiv.innerHTML = intervalsHtml;
    }
    
    // æ˜¾ç¤ºæ­Œå•ï¼ˆåˆå¹¶æ‰€æœ‰é€‰ä¸­éŸ³ç¨‹çš„æ­Œæ›²ï¼‰
    if (songsSection && songsDiv) {
        if (allSongs.length > 0) {
            // å»é‡
            const uniqueSongs = [...new Set(allSongs)];
            songsSection.style.display = 'block';
            songsDiv.innerHTML = `
                <ul class="song-list" style="margin-top: 8px;">
                    ${uniqueSongs.map(song => `
                        <li class="song-item" style="margin-bottom: 6px; font-size: 12px;">
                            ${song}
                        </li>
                    `).join('')}
                </ul>
            `;
        } else {
            songsDiv.innerHTML = '<p style="color: var(--text-secondary); font-size: 12px;">æš‚æ— å‚è€ƒæ­Œæ›²</p>';
        }
    }
}

// æ›´æ–°éŸ³é˜¶çŸ¥è¯†åº“ä¿¡æ¯
function updateScaleKB(scaleKey) {
    const kbInfo = scalesKB[scaleKey];
    const infoDiv = document.getElementById('current-scale-info');
    const songsDiv = document.getElementById('current-scale-songs');
    
    if (kbInfo) {
        // æ˜¾ç¤ºè¯´æ˜
        if (infoDiv) {
            infoDiv.innerHTML = `
                <div style="margin-bottom: 12px;">
                    <strong style="color: var(--hf-primary);">${kbInfo.name_zh || kbInfo.name_en}</strong>
                    <span style="color: var(--text-secondary); font-size: 11px; margin-left: 8px;">
                        ${kbInfo.name_en}
                    </span>
                </div>
                <p style="font-size: 13px; line-height: 1.6; color: var(--text-primary);">
                    ${kbInfo.characteristics_zh || 'æš‚æ— è¯´æ˜'}
                </p>
            `;
        }
        
        // æ˜¾ç¤ºæ­Œå•
        if (songsDiv) {
            if (kbInfo.songs && kbInfo.songs.length > 0) {
                songsDiv.innerHTML = `
                    <div style="margin-bottom: 8px;">
                        <strong style="color: var(--hf-primary);">${kbInfo.name_zh || kbInfo.name_en}</strong>
                    </div>
                    <ul class="song-list" style="margin-top: 8px;">
                        ${kbInfo.songs.map(song => `
                            <li class="song-item" style="margin-bottom: 6px; font-size: 12px;">
                                ${song}
                            </li>
                        `).join('')}
                    </ul>
                `;
            } else {
                songsDiv.innerHTML = '<p style="color: var(--text-secondary); font-size: 12px;">æš‚æ— å‚è€ƒæ­Œæ›²</p>';
            }
        }
    } else {
        if (infoDiv) {
            infoDiv.innerHTML = '<p style="color: var(--text-secondary); font-size: 12px;">è¯·é€‰æ‹©éŸ³é˜¶åæŸ¥çœ‹è¯¦ç»†ä¿¡æ¯</p>';
        }
        if (songsDiv) {
            songsDiv.innerHTML = '<p style="color: var(--text-secondary); font-size: 12px;">è¯·é€‰æ‹©éŸ³é˜¶åæŸ¥çœ‹å‚è€ƒæ­Œæ›²</p>';
        }
    }
}

// æ¸²æŸ“å•ä¸ªæ­Œæ›²å¡ç‰‡
function renderSongCard(song, index, timestamp) {
    // ä¼˜å…ˆä½¿ç”¨scoreå­—æ®µï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨functional_score
    const scoreUrl = (song.score && song.score.trim() !== '') 
        ? song.score 
        : (song.functional_score && song.functional_score.trim() !== '') 
            ? song.functional_score 
            : null;
    const hasScore = scoreUrl !== null;
    const hasAudio = song.audio && song.audio.trim() !== '';
    const audioId = `audio-${exerciseType}-${timestamp}-${index}`;
    
    return `
        <div class="song-item-card" style="margin-bottom: 16px; padding: 12px; background: var(--bg-secondary, #f9fafb); border: 1px solid var(--border, #e5e7eb); border-radius: 6px; overflow: hidden; word-wrap: break-word;">
            <div style="margin-bottom: 8px;">
                <strong style="color: var(--text-primary, #1f2937); font-size: 13px; display: block;">${song.song_name || 'æœªçŸ¥æ­Œæ›²'}</strong>
                ${song.artist ? `<span style="color: var(--text-secondary, #6b7280); font-size: 12px; display: block; margin-top: 4px;">${song.artist}</span>` : ''}
            </div>
            ${song.description ? `
                <p style="font-size: 12px; line-height: 1.5; color: var(--text-primary, #1f2937); margin-bottom: 8px; word-wrap: break-word;">
                    ${song.description}
                </p>
            ` : ''}
            ${hasScore ? `
                <div style="margin-bottom: 8px;">
                    <a href="${scoreUrl.startsWith('http') ? scoreUrl : `/static/${scoreUrl}`}" target="_blank" style="font-size: 12px; color: var(--hf-primary, #3b82f6); text-decoration: none; display: inline-flex; align-items: center; gap: 4px;">
                        ğŸ“„ æŸ¥çœ‹ä¹è°±
                    </a>
                </div>
            ` : ''}
            ${hasAudio ? `
                <div style="margin-top: 8px; width: 100%;">
                    <audio id="${audioId}" controls style="width: 100%; height: 32px; max-width: 100%;" data-audio-src="${song.audio}">
                        æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒéŸ³é¢‘æ’­æ”¾ã€‚
                    </audio>
                </div>
            ` : ''}
        </div>
    `;
}

// æ¸²æŸ“æ­Œæ›²åˆ—è¡¨ï¼ˆæ”¯æŒåˆ†ç»„æ˜¾ç¤ºï¼‰
function renderSongsList(songs, groupedData = null) {
    // å¦‚æœæä¾›äº†åˆ†ç»„æ•°æ®ï¼ŒæŒ‰åˆ†ç»„æ˜¾ç¤º
    if (groupedData && Object.keys(groupedData).length > 0) {
        const timestamp = Date.now();
        let globalIndex = 0;
        let html = '';
        
        Object.keys(groupedData).forEach((typeName, groupIndex) => {
            const songs = groupedData[typeName];
            if (!songs || songs.length === 0) return;
            
            // æ·»åŠ åˆ†å‰²çº¿å’Œæ ‡é¢˜ï¼ˆç¬¬ä¸€ä¸ªåˆ†ç»„å‰ä¸åŠ åˆ†å‰²çº¿ï¼‰
            if (groupIndex > 0) {
                html += `
                    <div style="margin: 24px 0 16px 0; border-top: 2px solid var(--border, #e5e7eb);"></div>
                `;
            }
            
            // æ·»åŠ ç±»å‹æ ‡é¢˜
            html += `
                <div style="margin-bottom: 12px;">
                    <h4 style="font-size: 14px; font-weight: 600; color: var(--text-primary, #1f2937); margin: 0;">
                        ${typeName}
                    </h4>
                </div>
            `;
            
            // æ¸²æŸ“è¯¥ç±»å‹ä¸‹çš„æ‰€æœ‰æ­Œæ›²
            songs.forEach((song, songIndex) => {
                html += renderSongCard(song, globalIndex++, timestamp);
            });
        });
        
        return html || '<p style="color: var(--text-secondary, #6b7280); font-size: 12px;">æš‚æ— å‚è€ƒæ­Œæ›²</p>';
    }
    
    // å¦‚æœæ²¡æœ‰åˆ†ç»„æ•°æ®ï¼ŒæŒ‰åŸæ¥çš„æ–¹å¼æ˜¾ç¤ºï¼ˆå‘åå…¼å®¹ï¼‰
    if (!songs || songs.length === 0) {
        return '<p style="color: var(--text-secondary, #6b7280); font-size: 12px;">æš‚æ— å‚è€ƒæ­Œæ›²</p>';
    }
    
    const timestamp = Date.now();
    return songs.map((song, index) => renderSongCard(song, index, timestamp)).join('');
}

// åˆå§‹åŒ–éŸ³é¢‘æ’­æ”¾å™¨ï¼Œé™åˆ¶æ’­æ”¾1åˆ†é’Ÿ
function initAudioPlayers() {
    document.querySelectorAll('audio[data-audio-src]').forEach(audio => {
        // å¦‚æœå·²ç»åˆå§‹åŒ–è¿‡ï¼Œè·³è¿‡
        if (audio.dataset.initialized === 'true') {
            return;
        }
        
        const audioSrc = audio.getAttribute('data-audio-src');
        if (audioSrc && !audio.src) {
            // æ„å»ºéŸ³é¢‘URL
            // audioSrcæ ¼å¼å¯èƒ½æ˜¯ "songs/xxx.mp3" æˆ–å®Œæ•´URL
            let audioUrl;
            if (audioSrc.startsWith('http')) {
                audioUrl = audioSrc;
            } else if (audioSrc.startsWith('songs/')) {
                // å¦‚æœå·²ç»æ˜¯songs/å¼€å¤´ï¼Œç›´æ¥æ‹¼æ¥
                audioUrl = `/static/audio/${audioSrc}`;
            } else {
                // å…¶ä»–æƒ…å†µï¼Œä¹Ÿæ‹¼æ¥
                audioUrl = `/static/audio/${audioSrc}`;
            }
            
            // è®¾ç½®éŸ³é¢‘æº
            audio.src = audioUrl;
            
            // æ ‡è®°ä¸ºå·²åˆå§‹åŒ–
            audio.dataset.initialized = 'true';
            
            // ç›‘å¬é”™è¯¯äº‹ä»¶
            audio.addEventListener('error', function(e) {
                console.error('éŸ³é¢‘åŠ è½½å¤±è´¥:', audioUrl, e);
                // ä¸æ˜¾ç¤ºé”™è¯¯ï¼Œè®©æµè§ˆå™¨é»˜è®¤å¤„ç†
            });
            
            // ç›‘å¬timeupdateäº‹ä»¶ï¼Œé™åˆ¶æ’­æ”¾1åˆ†é’Ÿ
            audio.addEventListener('timeupdate', function() {
                if (this.currentTime >= 60) {
                    this.pause();
                    this.currentTime = 60;
                }
            });
        }
    });
}

// æ›´æ–°JSONæ­Œæ›²æ˜¾ç¤º
function updateJsonSongsDisplay() {
    const container = document.getElementById('json-songs-container');
    if (!container || !songsData) return;
    
    // æ ¹æ®ç»ƒä¹ ç±»å‹è·å–songsæ•°æ®
    let groupedSongs = {};
    
    if (exerciseType === 'interval') {
        // è·å–é€‰ä¸­çš„éŸ³ç¨‹
        const checkedBoxes = document.querySelectorAll('input[name="intervals"]:checked');
        const selectedIntervals = Array.from(checkedBoxes).map(cb => cb.value);
        
        if (selectedIntervals.length === 0) {
            container.innerHTML = '<p style="color: var(--text-secondary, #6b7280); font-size: 12px;">è¯·é€‰æ‹©éŸ³ç¨‹åæŸ¥çœ‹å‚è€ƒæ­Œæ›²</p>';
            return;
        }
        
        // éŸ³ç¨‹åç§°æ˜ å°„
        const intervalNames = {
            'minor_second': 'å°äºŒåº¦',
            'major_second': 'å¤§äºŒåº¦',
            'minor_third': 'å°ä¸‰åº¦',
            'major_third': 'å¤§ä¸‰åº¦',
            'perfect_fourth': 'çº¯å››åº¦',
            'tritone': 'ä¸‰å…¨éŸ³',
            'perfect_fifth': 'çº¯äº”åº¦',
            'minor_sixth': 'å°å…­åº¦',
            'major_sixth': 'å¤§å…­åº¦',
            'minor_seventh': 'å°ä¸ƒåº¦',
            'major_seventh': 'å¤§ä¸ƒåº¦',
            'octave': 'å…«åº¦',
            'minor_ninth': 'å°ä¹åº¦',
            'major_ninth': 'å¤§ä¹åº¦',
            'minor_tenth': 'å°ååº¦',
            'eleventh': 'åä¸€åº¦',
            'major_thirteenth': 'å¤§åä¸‰åº¦'
        };
        
        selectedIntervals.forEach(intervalName => {
            if (songsData.interval && songsData.interval[intervalName]) {
                const intervalCnName = intervalNames[intervalName] || intervalName;
                groupedSongs[intervalCnName] = songsData.interval[intervalName];
            }
        });
    } else if (exerciseType === 'scale_degree') {
        // è·å–é€‰ä¸­çš„éŸ³é˜¶
        const scaleSelect = document.querySelector('select[name="scale_type"]');
        const selectedScale = scaleSelect ? scaleSelect.value : 'major';
        
        // éŸ³é˜¶åç§°æ˜ å°„
        const scaleNames = {
            'major': 'å¤§è°ƒ',
            'minor': 'å°è°ƒ',
            'natural_minor': 'è‡ªç„¶å°è°ƒ',
            'harmonic_minor': 'å’Œå£°å°è°ƒ',
            'melodic_minor': 'æ—‹å¾‹å°è°ƒ',
            'dorian': 'å¤šåˆ©äºšè°ƒå¼',
            'mixolydian': 'æ··åˆåˆ©åº•äºšè°ƒå¼',
            'lydian': 'åˆ©åº•äºšè°ƒå¼',
            'phrygian': 'å¼—é‡Œå‡ äºšè°ƒå¼',
            'locrian': 'æ´›å…‹é‡Œäºšè°ƒå¼',
            'pentatonic_major': 'å¤§è°ƒäº”å£°éŸ³é˜¶',
            'pentatonic_minor': 'å°è°ƒäº”å£°éŸ³é˜¶',
            'blues_scale': 'å¸ƒé²æ–¯éŸ³é˜¶',
            'blues': 'å¸ƒé²æ–¯éŸ³é˜¶',
            'whole_tone': 'å…¨éŸ³é˜¶',
            'diminished': 'å‡éŸ³é˜¶'
        };
        
        if (songsData.scale_degree && songsData.scale_degree[selectedScale]) {
            const scaleCnName = scaleNames[selectedScale] || selectedScale;
            groupedSongs[scaleCnName] = songsData.scale_degree[selectedScale];
        }
    } else if (songsData[exerciseType]) {
        // å…¶ä»–ç»ƒä¹ ç±»å‹ï¼Œæ˜¾ç¤ºæ‰€æœ‰songs
        Object.keys(songsData[exerciseType]).forEach(key => {
            const songList = songsData[exerciseType][key];
            if (Array.isArray(songList) && songList.length > 0) {
                groupedSongs[key] = songList;
            }
        });
    }
    
    const totalSongs = Object.values(groupedSongs).reduce((sum, songs) => sum + songs.length, 0);
    
    if (totalSongs === 0) {
        container.innerHTML = '<p style="color: var(--text-secondary, #6b7280); font-size: 12px;">æš‚æ— å‚è€ƒæ­Œæ›²</p>';
        return;
    }
    
    // æ¸²æŸ“æ­Œæ›²åˆ—è¡¨ï¼ˆæŒ‰ç±»å‹åˆ†ç»„ï¼‰
    container.innerHTML = renderSongsList(null, groupedSongs);
    // åˆå§‹åŒ–æ–°æ·»åŠ çš„éŸ³é¢‘æ’­æ”¾å™¨
    setTimeout(initAudioPlayers, 50);
}

// ç›‘å¬éŸ³ç¨‹é€‰æ‹©å˜åŒ–
document.addEventListener('DOMContentLoaded', function() {
    {% if exercise_type == 'interval' %}
    // ç›‘å¬éŸ³ç¨‹å¤é€‰æ¡†å˜åŒ–
    const intervalCheckboxes = document.querySelectorAll('input[name="intervals"]');
    intervalCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            // é€‰æ‹©å˜åŒ–æ—¶æ›´æ–°æ‰€æœ‰é€‰ä¸­çš„éŸ³ç¨‹
            updateIntervalKB();
            updateJsonSongsDisplay();
        });
    });
    
    // é»˜è®¤æ˜¾ç¤ºæ‰€æœ‰é€‰ä¸­çš„éŸ³ç¨‹
    updateIntervalKB();
    updateJsonSongsDisplay();
    {% elif exercise_type == 'scale_degree' %}
    // ç›‘å¬éŸ³é˜¶é€‰æ‹©å˜åŒ–
    const scaleSelect = document.querySelector('select[name="scale_type"]');
    if (scaleSelect) {
        scaleSelect.addEventListener('change', function() {
            updateScaleKB(this.value);
            updateJsonSongsDisplay();
        });
        
        // é»˜è®¤æ˜¾ç¤ºå½“å‰é€‰ä¸­çš„éŸ³é˜¶
        updateScaleKB(scaleSelect.value);
        updateJsonSongsDisplay();
    }
    {% else %}
    // å…¶ä»–ç»ƒä¹ ç±»å‹ï¼Œç›´æ¥æ˜¾ç¤º
    updateJsonSongsDisplay();
    {% endif %}
    
    // ä½¿ç”¨MutationObserverç›‘å¬DOMå˜åŒ–ï¼Œè‡ªåŠ¨åˆå§‹åŒ–æ–°æ·»åŠ çš„éŸ³é¢‘æ’­æ”¾å™¨
    const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
            if (mutation.addedNodes.length) {
                initAudioPlayers();
            }
        });
    });
    
    // å¼€å§‹è§‚å¯Ÿ
    const jsonSongsContainer = document.getElementById('json-songs-container');
    if (jsonSongsContainer) {
        observer.observe(jsonSongsContainer, {
            childList: true,
            subtree: true
        });
    }
    
    // åˆå§‹åŠ è½½æ—¶ä¹Ÿåˆå§‹åŒ–
    setTimeout(initAudioPlayers, 100);
});
</script>
{% endblock %}

