{% extends "base.html" %}

{% block title %}‰ªäÂ§©‰Ω†Âê¨‰∫ÜÂêó - openEar{% endblock %}

{% block extra_css %}
<style>
.statistics-page {
    background: var(--bg);
    min-height: calc(100vh - 56px);
    padding: 20px;
    max-width: 1200px;
    margin: 0 auto;
}

.statistics-header {
    margin-bottom: 32px;
}

.statistics-title {
    font-size: 16px;
    font-weight: 400;
    color: var(--text-secondary);
    margin-bottom: 24px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.statistics-title-icon {
    font-size: 18px;
}

.total-stats-section {
    background: var(--bg-secondary);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 40px 32px;
    margin-bottom: 32px;
    text-align: center;
}

.total-duration {
    font-size: 56px;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 12px;
    line-height: 1.2;
}

.total-duration .number {
    font-size: 56px;
    font-weight: 600;
}

.total-duration .unit {
    font-size: 20px;
    font-weight: 400;
    color: var(--text-secondary);
    margin: 0 4px;
}

.total-duration-subtitle {
    font-size: 14px;
    color: var(--text-secondary);
    margin-bottom: 32px;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 16px;
    margin-top: 32px;
}

.stat-item {
    text-align: center;
    padding: 20px;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    cursor: pointer;
    transition: all 0.2s;
}

.stat-item:hover {
    border-color: var(--primary);
    box-shadow: var(--shadow-sm);
}

.stat-value {
    font-size: 32px;
    font-weight: 600;
    color: var(--text-primary);
    line-height: 1.2;
    display: flex;
    align-items: baseline;
    gap: 4px;
}

.stat-value .stat-label {
    font-size: 16px;
    font-weight: 400;
    color: var(--text-secondary);
}

.stat-value .number {
    font-size: 32px;
    font-weight: 600;
}

.stat-value .unit {
    font-size: 16px;
    font-weight: 400;
    color: var(--text-secondary);
}

.exercise-cards-section {
    margin-bottom: 40px;
}

.section-title {
    font-size: 20px;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 20px;
}

.exercise-cards-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 16px;
}

.exercise-stat-card {
    background: var(--bg-secondary);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 20px;
    transition: all 0.2s;
    position: relative;
    overflow: hidden;
}

.exercise-stat-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: var(--primary);
    transform: scaleX(0);
    transition: transform 0.2s ease;
}

.exercise-stat-card:hover {
    border-color: var(--primary);
    box-shadow: var(--shadow-md);
    transform: translateY(-2px);
}

.exercise-stat-card:hover::before {
    transform: scaleX(1);
}

.exercise-stat-header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 16px;
}

.exercise-stat-icon {
    font-size: 24px;
    line-height: 1;
    flex-shrink: 0;
}

.exercise-stat-name {
    font-size: 18px;
    font-weight: 500;
    color: var(--text-primary);
    flex: 1;
}

.exercise-stat-level {
    font-size: 16px;
    font-weight: 600;
    padding: 6px 14px;
    border-radius: 12px;
    background: var(--primary-light);
    color: var(--primary);
}

.exercise-stat-level.level-low {
    background: #fee2e2;
    color: #dc2626;
}

.exercise-stat-stats {
    display: flex;
    align-items: center;
    gap: 16px;
    font-size: 12px;
    color: var(--text-tertiary);
    padding-top: 16px;
    border-top: 1px solid var(--border);
    flex-wrap: wrap;
}

.exercise-stat-stat {
    display: flex;
    align-items: center;
    gap: 4px;
}

.exercise-stat-stat-icon {
    font-size: 14px;
    filter: grayscale(100%);
    opacity: 0.7;
}

.chart-section {
    background: var(--bg-secondary);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 24px;
    margin-bottom: 32px;
}

.chart-title {
    font-size: 18px;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 20px;
}

.chart-container {
    position: relative;
    height: 300px;
}

.loading {
    text-align: center;
    padding: 40px;
    color: var(--text-secondary);
}

.empty-state {
    text-align: center;
    padding: 60px 20px;
    color: var(--text-secondary);
}

.empty-state-icon {
    font-size: 48px;
    margin-bottom: 16px;
    opacity: 0.5;
}

.empty-state-text {
    font-size: 14px;
}

@media (max-width: 768px) {
    .total-duration {
        font-size: 42px;
    }
    
    .total-duration .number {
        font-size: 42px;
    }
    
    .total-duration .unit {
        font-size: 16px;
    }
    
    .stat-value {
        font-size: 28px;
    }
    
    .stat-value .stat-label {
        font-size: 14px;
    }
    
    .stat-value .number {
        font-size: 28px;
    }
    
    .stat-value .unit {
        font-size: 14px;
    }
    
    .stats-grid {
        grid-template-columns: 1fr;
    }
    
    .exercise-cards-grid {
        grid-template-columns: 1fr;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="statistics-page">
    <div class="statistics-header">
        <h1 class="statistics-title">
            <span class="statistics-title-icon">üëÇ</span>
            <span>‰ªäÂ§©‰Ω†Âê¨‰∫ÜÂêó</span>
        </h1>
    </div>

    <div id="total-stats-section" class="total-stats-section">
        <div class="loading">Âä†ËΩΩ‰∏≠...</div>
    </div>

    <div class="exercise-cards-section">
        <h2 class="section-title">ÁªÉ‰π†Âç°Áâá</h2>
        <div id="exercise-cards-grid" class="exercise-cards-grid">
            <div class="loading">Âä†ËΩΩ‰∏≠...</div>
        </div>
    </div>

    <div class="chart-section">
        <h2 class="chart-title">ÁªÉ‰π†Êó∂ÈïøÂàÜÂ∏É</h2>
        <div class="chart-container">
            <canvas id="durationChart"></canvas>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
// ‰ªéÂêéÁ´Ø‰º†ÈÄíÁªÉ‰π†Á±ªÂûãÊï∞ÊçÆ
window.exerciseTypes = {{ exercise_types | tojson }};

let durationChart = null;

// Ê†ºÂºèÂåñÊó∂ÈïøÔºàÁßíËΩ¨Â∞èÊó∂ÂàÜÈíüÔºåÊï∞Â≠óÂ§ßÔºåÂçï‰ΩçÂ∞èÔºâ
function formatDuration(seconds) {
    const hours = Math.floor(seconds / 3600);
    const minutes = Math.floor((seconds % 3600) / 60);
    if (hours > 0) {
        return `<span class="number">${hours}</span><span class="unit">Â∞èÊó∂</span><span class="number">${minutes}</span><span class="unit">ÂàÜÈíü</span>`;
    }
    return `<span class="number">${minutes}</span><span class="unit">ÂàÜÈíü</span>`;
}

// Ê†ºÂºèÂåñÊó•Êúü
function formatDate(dateStr) {
    const date = new Date(dateStr);
    return date.toLocaleDateString('zh-CN', { year: 'numeric', month: 'long', day: 'numeric' });
}

// Âä†ËΩΩÁªüËÆ°Êï∞ÊçÆ
async function loadStatistics() {
    try {
        const response = await fetch('/api/statistics');
        const data = await response.json();
        
        if (data.status === 'ok') {
            renderTotalStats(data);
            renderExerciseCards(data);
            renderChart(data);
        }
    } catch (error) {
        console.error('Âä†ËΩΩÁªüËÆ°Êï∞ÊçÆÂ§±Ë¥•:', error);
    }
}

// Ê∏≤ÊüìÊÄªÁªüËÆ°
function renderTotalStats(data) {
    const totalDuration = formatDuration(data.total_duration);
    const totalQuestions = data.total_questions || 0;
    const totalCorrect = data.total_correct || 0;
    const practiceDays = data.practice_days || 0;
    const notesCount = 0; // ÊöÇÊó∂‰∏∫0
    
    // ËÆ°ÁÆóÂºÄÂßãÊó•Êúü
    let startDate = '';
    if (data.daily_stats && data.daily_stats.length > 0) {
        const lastDate = data.daily_stats[data.daily_stats.length - 1].date;
        startDate = formatDate(lastDate);
    }
    
    const daysSinceStart = data.daily_stats ? data.daily_stats.length : 0;
    
    const html = `
        <div class="total-duration">${totalDuration}</div>
        ${startDate ? `<div class="total-duration-subtitle">${startDate}Ëá≥‰ªä ¬∑ ‰∏éopenEarÁõ∏‰º¥${daysSinceStart}Â§©</div>` : ''}
        <div class="stats-grid">
            <div class="stat-item">
                <div class="stat-value">
                    <span class="stat-label">Âê¨Ëøá</span>
                    <span class="number">${totalQuestions}</span><span class="unit">È¢ò</span>
                </div>
            </div>
            <div class="stat-item">
                <div class="stat-value">
                    <span class="stat-label">Á≠îÂØπ</span>
                    <span class="number">${totalCorrect}</span><span class="unit">È¢ò</span>
                </div>
            </div>
            <div class="stat-item">
                <div class="stat-value">
                    <span class="stat-label">ÁªÉ‰π†</span>
                    <span class="number">${practiceDays}</span><span class="unit">Â§©</span>
                </div>
            </div>
            <div class="stat-item">
                <div class="stat-value">
                    <span class="stat-label">Á¨îËÆ∞</span>
                    <span class="number">${notesCount}</span><span class="unit">Êù°</span>
                </div>
            </div>
        </div>
    `;
    
    document.getElementById('total-stats-section').innerHTML = html;
}

// Ê∏≤ÊüìÁªÉ‰π†Âç°ÁâáÔºàÊåâ‰∏ªÈ°µÈ°∫Â∫èÔºâ
function renderExerciseCards(data) {
    const exerciseTypes = window.exerciseTypes || {};
    const exerciseStats = data.exercise_stats || {};
    
    // ÊåâÁÖß‰∏ªÈ°µÁöÑÈ°∫Â∫èÔºöinterval, scale_degree, chord_quality, chord_inversion, chord_progression, melody
    const exerciseOrder = ['interval', 'scale_degree', 'chord_quality', 'chord_inversion', 'chord_progression', 'melody'];
    
    let html = '';
    
    for (const key of exerciseOrder) {
        const info = exerciseTypes[key];
        if (!info) continue;
        
        const stats = exerciseStats[key] || {
            duration: 0,
            total_questions: 0,
            accuracy: 0,
            practice_count: 0
        };
        
        const durationMinutes = Math.floor(stats.duration / 60);
        const durationHours = Math.floor(durationMinutes / 60);
        const durationMinutesRemainder = durationMinutes % 60;
        const durationText = durationHours > 0 
            ? `${durationHours}Â∞èÊó∂${durationMinutesRemainder}ÂàÜÈíü`
            : `${durationMinutes}ÂàÜÈíü`;
        
        const accuracy = stats.accuracy || 0;
        const level = getAccuracyLevel(accuracy);
        const practiceCount = stats.practice_count || 0;
        
        // ‰Ωé‰∫éCÊòæÁ§∫Á∫¢Ëâ≤
        const levelClass = (level === 'D' || level === 'E') ? 'level-low' : '';
        
        html += `
            <div class="exercise-stat-card">
                <div class="exercise-stat-header">
                    <div class="exercise-stat-icon">${info.icon}</div>
                    <div class="exercise-stat-name">${info.name}</div>
                    <div class="exercise-stat-level ${levelClass}">${level}</div>
                </div>
                <div class="exercise-stat-stats">
                    <div class="exercise-stat-stat">
                        <span class="exercise-stat-stat-icon">üïê</span>
                        <span>${durationText}</span>
                    </div>
                    <div class="exercise-stat-stat">
                        <span class="exercise-stat-stat-icon">üèÜ</span>
                        <span>${accuracy.toFixed(0)}%</span>
                    </div>
                    <div class="exercise-stat-stat">
                        <span class="exercise-stat-stat-icon">üìä</span>
                        <span>${practiceCount} Ê¨°</span>
                    </div>
                    <div class="exercise-stat-stat">
                        <span class="exercise-stat-stat-icon">‚≠ê</span>
                        <span>${stats.total_questions} È¢ò</span>
                    </div>
                </div>
            </div>
        `;
    }
    
    if (html === '') {
        html = '<div class="empty-state"><div class="empty-state-icon">üìä</div><div class="empty-state-text">ÊöÇÊó†ÁªÉ‰π†Êï∞ÊçÆ</div></div>';
    }
    
    document.getElementById('exercise-cards-grid').innerHTML = html;
}

// Ëé∑ÂèñÂáÜÁ°ÆÁéáÁ≠âÁ∫ß
function getAccuracyLevel(accuracy) {
    if (accuracy >= 80) return 'A';
    if (accuracy >= 60) return 'B';
    if (accuracy >= 40) return 'C';
    if (accuracy >= 20) return 'D';
    return 'E';
}

// Ê∏≤ÊüìÂõæË°®ÔºàÊåâÂë®ÊòæÁ§∫Ôºâ
function renderChart(data) {
    const ctx = document.getElementById('durationChart').getContext('2d');
    
    // ‰ΩøÁî®Âë®Êï∞ÊçÆ
    const chartData = data.weekly_stats || [];
    
    // ËΩ¨Êç¢‰∏∫ÂõæË°®Ê†ºÂºèÔºàÊåâÂë®ÊéíÂ∫èÔºåÊúÄÊñ∞ÁöÑÂú®ÂâçÔºâ
    const sortedData = chartData.sort((a, b) => a.period.localeCompare(b.period));
    
    // Ê†ºÂºèÂåñÂë®Ê†áÁ≠æÔºàÂ¶Ç "2025-W52" -> "2025Âπ¥Á¨¨52Âë®"Ôºâ
    const labels = sortedData.map(item => {
        const [year, week] = item.period.split('-W');
        return `${year}Âπ¥Á¨¨${parseInt(week)}Âë®`;
    });
    
    // ËΩ¨Êç¢‰∏∫Â∞èÊó∂
    const durations = sortedData.map(item => Math.round(item.duration / 3600 * 100) / 100);
    
    // Â¶ÇÊûúÂ∑≤ÊúâÂõæË°®ÔºåÈîÄÊØÅÂÆÉ
    if (durationChart) {
        durationChart.destroy();
    }
    
    // ÊâæÂà∞ÊúÄÂ§ßÂÄºÁî®‰∫éËÆæÁΩÆYËΩ¥
    const maxDuration = Math.max(...durations, 0);
    const yAxisMax = Math.ceil(maxDuration / 10) * 10; // Âêë‰∏äÂèñÊï¥Âà∞10ÁöÑÂÄçÊï∞
    
    durationChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'ÁªÉ‰π†Êó∂ÈïøÔºàÂ∞èÊó∂Ôºâ',
                data: durations,
                backgroundColor: 'rgba(59, 130, 246, 0.6)',
                borderColor: 'rgba(59, 130, 246, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const hours = Math.floor(context.parsed.y);
                            const minutes = Math.round((context.parsed.y - hours) * 60);
                            if (hours > 0) {
                                return `${hours}Â∞èÊó∂${minutes}ÂàÜÈíü`;
                            }
                            return `${minutes}ÂàÜÈíü`;
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    max: yAxisMax > 0 ? yAxisMax : 10,
                    ticks: {
                        callback: function(value) {
                            return value + 'h';
                        }
                    }
                },
                x: {
                    ticks: {
                        maxRotation: 45,
                        minRotation: 0
                    }
                }
            }
        }
    });
}

// È°µÈù¢Âä†ËΩΩÊó∂ÂàùÂßãÂåñ
document.addEventListener('DOMContentLoaded', () => {
    loadStatistics();
});
</script>
{% endblock %}
